<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Universal ABPC</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #2c3e50;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #ecf0f1;
        }

        /* --- CONTROLES --- */
        .controls {
            background: #fff;
            color: #333;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            width: 95%;
            max-width: 900px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border-top: 5px solid #e67e22;
        }

        .input-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
            align-items: flex-end;
        }

        .input-group {
            flex: 1;
            min-width: 180px;
            text-align: left;
        }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #555; }
        
        select, input[type="color"], input[type="number"], input[type="text"], input[type="file"] {
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 5px;
            width: 100%;
            border: 1px solid #ccc;
            background: #f9f9f9;
            height: 38px;
            box-sizing: border-box;
        }
        
        /* Ajuste espec√≠fico para input file */
        input[type="file"] { padding: 5px; }

        /* Inputs para tama√±o personalizado */
        .custom-dims {
            display: none; /* Oculto por defecto */
            gap: 10px;
            background: #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            border: 1px dashed #e67e22;
        }
        .custom-dims.active { display: flex; }

        .btn-print {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: background 0.2s;
        }
        .btn-print:hover { background-color: #d35400; }

        .info-bar {
            background-color: #ecf0f1;
            color: #2c3e50;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 10px;
            font-weight: bold;
        }
        
        /* Toggle Radio Buttons */
        .radio-group {
            display: flex;
            gap: 15px;
            margin-bottom: 5px;
        }
        .radio-group label {
            font-weight: normal;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        input[type="radio"] { width: auto; height: auto; margin: 0; }

        /* --- VISTA PREVIA --- */
        .preview-area {
            width: 100%;
            overflow: auto;
            background-color: #95a5a6;
            padding: 40px;
            box-sizing: border-box;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            border: 1px solid #7f8c8d;
        }

        /* --- HOJA DIN√ÅMICA --- */
        .sheet {
            background-color: white;
            padding: 0.25in; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: flex-start;
            gap: 0.12in; 
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transform-origin: top center;
            transition: width 0.3s, height 0.3s;
        }
        
        .sheet-header {
            width: 100%;
            text-align: center;
            border-bottom: 2px solid #333;
            margin-bottom: 0.1in;
            padding-bottom: 5px;
            font-weight: bold;
            font-size: 10pt;
            text-transform: uppercase;
            color: #333;
        }

        .strip-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .cut-line {
            width: 100%;
            border-top: 1px dashed #bbb;
            position: absolute;
            bottom: -0.06in; 
            left: 0;
            z-index: 0;
        }
        .sheet .strip-wrapper:last-child .cut-line { display: none; }

        .strip-label {
            font-size: 8pt;
            color: #999;
            font-weight: bold;
            width: 100%;
            text-align: left;
            position: absolute;
            top: -12px;
            left: 0;
        }

        svg { overflow: visible; display: block; z-index: 1; }
        text { font-family: 'Arial Black', Arial, sans-serif; font-weight: 900; }

        @media print {
            body { background: none; margin: 0; padding: 0; }
            .controls, .preview-area::-webkit-scrollbar { display: none; }
            .preview-area { padding: 0; background: none; width: 100%; display: block; }
            .sheet { margin: 0; box-shadow: none; }
        }
        
        @page { margin: 0; } 
    </style>
    <style id="page-style"></style>
</head>
<body>

    <div class="controls">
        <div class="input-row">
            <div class="input-group">
                <label>1. TAMA√ëO PAPEL:</label>
                <select id="paperSelect" onchange="handlePaperChange()">
                    <option value="tabloid">Tabloide (11" x 17")</option>
                    <option value="superTabloid">Super Tabloide (12" x 18")</option>
                    <option value="a3">A3 (29.7cm x 42cm)</option>
                    <option value="a3plus">A3+ (32.9cm x 48.3cm)</option>
                    <option value="custom29x49">Recorte (29cm x 49cm)</option>
                    <option value="custom">üìè PERSONALIZADO (Ingresar medidas)</option>
                </select>
            </div>

            <!-- Inputs ocultos para personalizado -->
            <div class="input-group custom-dims" id="customInputs">
                <div style="flex:1">
                    <label>ANCHO (cm):</label>
                    <input type="number" id="customW" value="50" step="0.5" onchange="updateCustomSize()">
                </div>
                <div style="flex:1">
                    <label>ALTO (cm):</label>
                    <input type="number" id="customH" value="40" step="0.5" onchange="updateCustomSize()">
                </div>
            </div>

            <div class="input-group">
                <label>2. CONTENIDO:</label>
                <select id="layoutSelect" onchange="renderSheet()">
                    <option value="mix">MIXTO (Optimizado)</option>
                    <option value="10">SOLO 10 PIES (14")</option>
                    <option value="9">SOLO 9 PIES (12.5")</option>
                    <option value="8">SOLO 8 PIES (11")</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>3. FONDO:</label>
                <select id="bgMode" onchange="toggleColorPicker()">
                    <option value="transparent">Transparente</option>
                    <option value="black" selected>Negro (Cl√°sico)</option>
                    <option value="custom">Color...</option>
                </select>
            </div>
            
            <div class="input-group" id="colorPickerGroup" style="display:none; max-width: 60px;">
                <label>COLOR:</label>
                <input type="color" id="customColorInput" value="#1a5276" onchange="renderSheet()">
            </div>
        </div>
        
        <!-- SECCI√ìN DE ETIQUETA PERSONALIZADA -->
        <div class="input-row" style="border-top: 1px dashed #ccc; padding-top: 15px;">
            <div class="input-group" style="max-width: 400px;">
                <label>4. ETIQUETA CENTRAL (PERSONALIZAR):</label>
                <div class="radio-group">
                    <label><input type="radio" name="lblType" value="text" checked onchange="toggleLabelMode()"> Texto</label>
                    <label><input type="radio" name="lblType" value="image" onchange="toggleLabelMode()"> Imagen/Logo</label>
                </div>
                
                <div id="textInputContainer">
                    <input type="text" id="customLabelText" value="ABPC" placeholder="Ej: TU CLUB" onkeyup="updateLabelText()">
                </div>
                
                <div id="imageInputContainer" style="display:none;">
                    <input type="file" id="customLabelImg" accept="image/*" onchange="handleImageUpload()">
                    <div id="imgStatus" style="font-size:11px; color:#27ae60; margin-top:2px; display:none;">Imagen cargada correctamente.</div>
                </div>
            </div>
        </div>

        <div class="info-bar" id="statusMsg">
            Calculando capacidad...
        </div>

        <button class="btn-print" onclick="window.print()" style="margin-top:10px;">üñ®Ô∏è IMPRIMIR</button>
    </div>

    <div class="preview-area">
        <div class="sheet" id="sheetContent">
            <!-- Contenido JS -->
        </div>
    </div>

    <script>
        // Configuraci√≥n Base
        const STRIP_H_IN = 1.35; // Altura fija de la tira
        const MIN_GAP_IN = 0.12; // Espacio m√≠nimo para tijera
        const MARGIN_V_IN = 0.5; // Margen vertical total (arriba+abajo) de la hoja

        // Variables de Estado
        let currentW = 17;
        let currentH = 11;
        let currentName = "Tabloide";
        let maxCapacity = 0;
        
        // Estado de Etiqueta
        let labelMode = 'text'; // 'text' o 'image'
        let labelTextStr = 'ABPC';
        let labelImgData = null; // Base64 de la imagen
        let labelImgRatio = 1; // ancho/alto

        // Tama√±os predefinidos
        const presets = {
            'tabloid': { w: 17, h: 11, name: 'Tabloide (11x17")' },
            'superTabloid': { w: 18, h: 12, name: 'Super Tabloide (12x18")' },
            'a3': { w: 16.54, h: 11.69, name: 'A3 Standard' }, 
            'a3plus': { w: 19.02, h: 12.95, name: 'A3+ / Super B' }, 
            'custom29x49': { w: 19.29, h: 11.42, name: 'Recorte 29x49 cm' }
        };

        // --- MANEJO DE ETIQUETA ---
        function toggleLabelMode() {
            const radios = document.getElementsByName('lblType');
            for(let r of radios) {
                if(r.checked) labelMode = r.value;
            }
            
            document.getElementById('textInputContainer').style.display = labelMode === 'text' ? 'block' : 'none';
            document.getElementById('imageInputContainer').style.display = labelMode === 'image' ? 'block' : 'none';
            
            renderSheet();
        }

        function updateLabelText() {
            labelTextStr = document.getElementById('customLabelText').value || "";
            renderSheet();
        }

        function handleImageUpload() {
            const fileInput = document.getElementById('customLabelImg');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('imgStatus');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        labelImgData = e.target.result;
                        labelImgRatio = img.width / img.height;
                        statusDiv.style.display = 'block';
                        renderSheet();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // --- LOGICA PAPEL ---
        function handlePaperChange() {
            const val = document.getElementById('paperSelect').value;
            const customDiv = document.getElementById('customInputs');

            if (val === 'custom') {
                customDiv.classList.add('active');
                updateCustomSize(); 
            } else {
                customDiv.classList.remove('active');
                const p = presets[val];
                currentW = p.w;
                currentH = p.h;
                currentName = p.name;
                updateSystem();
            }
        }

        function updateCustomSize() {
            const wCm = parseFloat(document.getElementById('customW').value) || 20;
            const hCm = parseFloat(document.getElementById('customH').value) || 20;
            currentW = wCm / 2.54;
            currentH = hCm / 2.54;
            currentName = `Personalizado (${wCm}x${hCm} cm)`;
            updateSystem();
        }

        function calculateCapacity() {
            const availableH = currentH - MARGIN_V_IN - 0.2; 
            const unitH = STRIP_H_IN + MIN_GAP_IN;
            let count = Math.floor(availableH / unitH);
            if (count < 1) count = 0;
            return count;
        }

        function updateSystem() {
            maxCapacity = calculateCapacity();
            const styleElem = document.getElementById('page-style');
            styleElem.innerHTML = `@page { size: ${currentW}in ${currentH}in; margin: 0; }`;
            const sheet = document.getElementById('sheetContent');
            sheet.style.width = currentW + 'in';
            sheet.style.height = currentH + 'in';

            const msg = document.getElementById('statusMsg');
            let warn = "";
            if (currentW < 14.5) warn = " ‚ö†Ô∏è ¬°CUIDADO! Ancho insuficiente para tira de 10 pies (14\").";
            msg.innerText = `Papel: ${currentName} | Capacidad: ${maxCapacity} Tiras.${warn}`;
            msg.style.color = warn ? "#c0392b" : "#2c3e50";

            renderSheet();
        }

        function toggleColorPicker() {
            const mode = document.getElementById('bgMode').value;
            document.getElementById('colorPickerGroup').style.display = (mode === 'custom') ? 'block' : 'none';
            renderSheet();
        }

        // --- RENDERIZADO SVG ---
        const configs = {
            '10': { inches: 14.0, label: '10 Pies' },
            '9':  { inches: 12.5, label: '9 Pies' },
            '8':  { inches: 11.0, label: '8 Pies' }
        };

        function getStripSVG(type) {
            const conf = configs[type];
            const w = conf.inches;
            const h = STRIP_H_IN;
            
            const bgMode = document.getElementById('bgMode').value;
            let fillBody, strokeBorder, textColor, guideColor, tickColor;
            const cCyan = "#00FFFF"; 
            const cGold = "#FFD700";

            if (bgMode === 'transparent') {
                fillBody = "none"; strokeBorder = "#000"; textColor = "#000"; tickColor = "#009999"; guideColor = "#000";
            } else if (bgMode === 'black') {
                fillBody = "#111"; strokeBorder = "none"; textColor = "#FFF"; tickColor = cCyan; guideColor = "#FFF";
            } else {
                fillBody = document.getElementById('customColorInput').value; strokeBorder = "none";
                const isDark = parseInt(fillBody.substring(1), 16) < 0xffffff / 2;
                textColor = isDark ? "#FFF" : "#000"; guideColor = textColor; tickColor = isDark ? cCyan : "#000";
            }

            let ticks = "";
            const step = w / 10;
            for(let i=1; i<10; i++) {
                if(i===5) continue;
                ticks += `<line x1="${step*i}" y1="${(h/2)-0.25}" x2="${step*i}" y2="${(h/2)+0.25}" />`;
            }

            const cutBorder = `<rect x="0" y="0" width="${w}" height="${h}" rx="0.15" fill="none" stroke="#999" stroke-width="0.015" stroke-dasharray="0.1, 0.1"/>`;

            // GENERAR CONTENIDO DE ETIQUETA
            let labelContent = "";
            if (labelMode === 'image' && labelImgData) {
                // Altura objetivo de imagen: 0.35 pulgadas
                const imgH = 0.35;
                const imgW = imgH * labelImgRatio;
                // Centrar: (ancho_tira / 2) - (ancho_img / 2)
                const imgX = (w / 2) - (imgW / 2);
                const imgY = h - 0.45; // Posici√≥n Y cerca del fondo
                labelContent = `<image href="${labelImgData}" x="${imgX}" y="${imgY}" height="${imgH}" width="${imgW}" />`;
            } else {
                // Texto por defecto o personalizado
                labelContent = `<text x="${w/2}" y="${h-0.15}" font-size="0.18" fill="${textColor}" text-anchor="middle" opacity="0.9">${labelTextStr}</text>`;
            }

            return `
            <div class="strip-wrapper">
                <div class="strip-label" style="color:${textColor === '#FFF' ? '#999' : '#555'}">${conf.label}</div>
                <svg width="${w}in" height="${h}in" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
                    <rect x="0" y="0" width="${w}" height="${h}" rx="0.15" fill="${fillBody}" stroke="${strokeBorder}" stroke-width="0.02"/>
                    ${bgMode !== 'black' && bgMode !== 'custom' ? cutBorder : ''}
                    <line x1="0" y1="${h/2}" x2="${w}" y2="${h/2}" stroke="${tickColor}" stroke-width="0.01" opacity="0.5"/>
                    <g stroke="${tickColor}" stroke-width="0.04">${ticks}</g>
                    <polygon points="${w/2},${h/2-0.25} ${w/2+0.3},${h/2} ${w/2},${h/2+0.25} ${w/2-0.3},${h/2}" fill="${cGold}" stroke="#B8860B" stroke-width="0.01"/>
                    
                    ${labelContent}
                    
                    <path d="M0,${h/2} L0.25,${h/2+0.2} L0.25,${h/2-0.2} Z" fill="${guideColor}" opacity="0.8"/>
                    <path d="M${w},${h/2} L${w-0.25},${h/2+0.2} L${w-0.25},${h/2-0.2} Z" fill="${guideColor}" opacity="0.8"/>
                </svg>
                <div class="cut-line"></div>
            </div>`;
        }

        function renderSheet() {
            const layoutType = document.getElementById('layoutSelect').value;
            const container = document.getElementById('sheetContent');
            
            let html = `<div class="sheet-header">PLANTILLA - ${currentName}</div>`;

            if (maxCapacity > 0) {
                if (layoutType === 'mix') {
                    const base = Math.floor(maxCapacity / 3);
                    let rem = maxCapacity % 3;
                    const c10 = base + (rem > 0 ? 1 : 0);
                    const c9 = base + (rem > 1 ? 1 : 0);
                    const c8 = base;

                    for(let i=0; i<c10; i++) html += getStripSVG('10');
                    for(let i=0; i<c9; i++) html += getStripSVG('9');
                    for(let i=0; i<c8; i++) html += getStripSVG('8');
                } else {
                    for(let i=0; i<maxCapacity; i++) html += getStripSVG(layoutType);
                }
            } else {
                html += `<div style="padding:20px; color:red; font-weight:bold;">El papel es muy peque√±o para imprimir tiras.</div>`;
            }

            container.innerHTML = html;
        }

        updateSystem();
    </script>
</body>
</html>
