<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herrameintas Para El Billar</title>
    
    <!-- Librer√≠as de ambas herramientas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* =========================================
           ESTILOS GLOBALES Y BARRA DE NAVEGACI√ìN
           ========================================= */
        body {
            margin: 0;
            padding: 0;
            background-color: #111827; /* Fondo neutro oscuro base */
            font-family: system-ui, -apple-system, sans-serif;
        }

        .main-system-nav {
            background-color: #1f2937;
            padding: 12px 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            position: sticky;
            top: 0;
            z-index: 9999;
            border-bottom: 2px solid #374151;
        }

        .main-system-nav button {
            background-color: #374151;
            color: #9ca3af;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .main-system-nav button:hover {
            background-color: #4b5563;
            color: white;
        }

        .main-system-nav button.active {
            background-color: #2563eb;
            color: white;
            box-shadow: inset 0 -4px 0 #f1c40f; /* Detalle amarillo para hacer gui√±o a ABPC */
        }

        .app-container {
            display: none;
            min-height: calc(100vh - 64px); /* Resta la altura del men√∫ superior */
        }

        .app-container.active {
            display: flex; /* Se usa flex porque ambos body originales usaban flex */
        }

        /* ESTILOS GLOBALES DEL MODAL EXTRACTOR */
        .global-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.85); z-index: 10000;
            display: none; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box; backdrop-filter: blur(4px);
        }
        .global-modal-overlay.active { display: flex; }

        @media print {
            .no-print { display: none !important; }
            #app1-wrapper, #app2-wrapper { background: white !important; padding: 0 !important; }
            .sheet-container { box-shadow: none !important; border: none !important; }
        }

        /* =========================================
           ESTILOS APP 1: GENERADOR ABPC
           ========================================= */
        #app1-wrapper {
            --primary: #2c3e50;
            --accent: #f1c40f;
            --glass: rgba(255, 255, 255, 0.98);
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--primary);
            background-image: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            padding: 20px;
            flex-direction: column;
            align-items: center;
            color: #333;
            width: 100%;
            box-sizing: border-box;
        }
        #app1-wrapper .main-panel { background-color: var(--glass); padding: 30px; border-radius: 16px; width: 95%; max-width: 1000px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-top: 8px solid var(--accent); }
        #app1-wrapper .header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        #app1-wrapper h1 { margin: 0; font-size: 28px; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; font-weight: 900; }
        #app1-wrapper .live-preview-container { background: #fff; border: 2px solid #bdc3c7; border-radius: 10px; padding: 20px; margin-bottom: 25px; text-align: center; overflow-x: auto; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); }
        #app1-wrapper .live-label { font-size: 12px; font-weight: bold; color: #7f8c8d; text-transform: uppercase; margin-bottom: 10px; display: block; }
        #app1-wrapper .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        #app1-wrapper .control-group { background: white; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0; transition: transform 0.2s; }
        #app1-wrapper .control-group:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        #app1-wrapper label { display: block; font-weight: 800; font-size: 12px; margin-bottom: 8px; color: #555; text-transform: uppercase; }
        #app1-wrapper select, #app1-wrapper input[type="number"], #app1-wrapper input[type="text"] { width: 100%; padding: 10px; border: 2px solid #eee; border-radius: 6px; font-size: 14px; background: #f9f9f9; box-sizing: border-box; }
        #app1-wrapper input[type="color"] { -webkit-appearance: none; border: none; width: 100%; height: 38px; padding: 0; background: none; cursor: pointer; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        #app1-wrapper .quick-qty { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;}
        #app1-wrapper .q-btn { flex: 1; background: #dfe6e9; border: none; padding: 8px; font-size: 11px; border-radius: 4px; cursor: pointer; color: #2d3436; font-weight: bold; transition: background 0.2s; min-width: 60px; }
        #app1-wrapper .q-btn.active { background: var(--primary); color: white; }
        #app1-wrapper #btnTestQty { display: none; background-color: #f1c40f; color: #333; flex: 0 0 auto; width: auto;} 
        #app1-wrapper .toggle-container { display: flex; background: #eee; border-radius: 6px; padding: 4px; margin-bottom: 15px; }
        #app1-wrapper .toggle-btn { flex: 1; text-align: center; padding: 8px; font-size: 12px; font-weight: bold; cursor: pointer; border-radius: 4px; color: #777; }
        #app1-wrapper .toggle-btn.active { background: white; color: #e67e22; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #app1-wrapper .btn-action { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); color: white; border: none; padding: 20px; width: 100%; font-size: 18px; font-weight: 800; border-radius: 8px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 10px 20px rgba(230, 126, 34, 0.3); transition: all 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 15px; }
        #app1-wrapper .btn-action:hover { transform: translateY(-3px); box-shadow: 0 15px 25px rgba(230, 126, 34, 0.4); }
        #app1-wrapper .btn-guide { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; padding: 15px; width: 100%; font-size: 14px; font-weight: 700; border-radius: 8px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3); transition: all 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; }
        #app1-wrapper .btn-guide:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(52, 152, 219, 0.4); }
        #app1-wrapper .info-box { background: #fadbd8; color: #922b21; padding: 15px; border-radius: 8px; font-size: 13px; margin-bottom: 20px; border-left: 4px solid #c0392b; font-weight: 600; }
        #app1-wrapper .footer-cr { text-align: center; margin-top: 30px; font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; }
        #app1-wrapper .custom-strip-input { display: none; margin-top:10px; padding:10px; background:#fef9e7; border:1px dashed #f39c12; border-radius:6px; }
        #app1-wrapper .diamond-color-wrapper { margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; }
        #app1-wrapper .custom-sheet-container { display: none; margin-top:10px; padding:10px; background:#e8f6f3; border:1px dashed #1abc9c; border-radius:6px; }
        #app1-wrapper .custom-sheet-row { display: flex; gap: 10px; align-items: flex-end; }
        #app1-wrapper .mix-row { display: grid; grid-template-columns: 60px 1fr 40px 40px; gap: 5px; margin-bottom: 8px; background: #f8f9fa; padding: 8px; border-radius: 6px; align-items: center; }
        #app1-wrapper .mix-row label { margin: 0; font-size: 11px; }
        #app1-wrapper .mix-row select { padding: 6px; font-size: 12px; }
        #app1-wrapper .mix-row input[type="color"] { margin-top: 0; height: 30px; }

        /* =========================================
           ESTILOS APP 2: STROKEMASTER PRO
           ========================================= */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap');

        #app2-wrapper {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            background-color: #f8fafc;
            font-family: 'Roboto', sans-serif;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #1e293b;
            width: 100%;
            box-sizing: border-box;
        }
        #app2-wrapper .header-container { text-align: center; margin-bottom: 25px; }
        #app2-wrapper .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        #app2-wrapper .tab-btn { padding: 10px 20px; border: none; background: #fff; cursor: pointer; font-weight: bold; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: 0.2s; color: #64748b; }
        #app2-wrapper .tab-btn.active { background: var(--primary); color: white; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        #app2-wrapper .workspace { display: none; flex-direction: column; align-items: center; width: 100%; }
        #app2-wrapper .workspace.active { display: flex; }
        #app2-wrapper .controls { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; justify-content: center; border: 1px solid #e2e8f0; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        #app2-wrapper .control-group { display: flex; flex-direction: column; gap: 4px; }
        #app2-wrapper .label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.5px; }
        #app2-wrapper select, #app2-wrapper input[type="text"], #app2-wrapper input[type="color"] { padding: 8px 12px; border-radius: 6px; border: 1px solid #cbd5e1; background: #f8fafc; font-size: 14px; color: #334155; height: 38px; box-sizing: border-box; }
        #app2-wrapper input[type="color"] { padding: 2px 6px; width: 50px; cursor: pointer; }
        #app2-wrapper .btn-action { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 900; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; height: 38px; text-transform: uppercase; font-size: 12px; }
        #app2-wrapper .btn-pdf { background: #ef4444; color: white; }
        #app2-wrapper .btn-info { background: #0ea5e9; color: white; }
        #app2-wrapper .sheet-container { background: white; margin: 0 auto; position: relative; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.08); border: 1px solid #eee; }
        #app2-wrapper .hairline { fill: none; stroke: #000; stroke-width: 0.12mm; }
        #app2-wrapper .cut-line { fill: none; stroke: #ff0000; stroke-width: 0.25mm; stroke-dasharray: 4 2; }
        #app2-wrapper .reg-mark { stroke: #333; stroke-width: 0.1mm; }
        #app2-wrapper .zone-label { font-family: 'Roboto', sans-serif; font-weight: 900; fill: rgba(255,255,255,0.15); text-transform: uppercase; }
        
        /* ESTILOS DEL MODAL Y LA GU√çA T√âCNICA */
        #app2-wrapper .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.85); z-index: 10000;
            display: none; justify-content: center; align-items: flex-start;
            overflow-y: auto; overflow-x: auto; padding: 40px 20px; box-sizing: border-box;
            backdrop-filter: blur(4px);
        }
        #app2-wrapper .modal-overlay.active { display: flex; }
        
        #app2-wrapper .modal-content-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            margin: auto; /* Centrado vertical/horizontal natural */
        }
        
        #app2-wrapper .modal-toolbar {
            display: flex; gap: 15px; width: 100%; max-width: 794px; justify-content: flex-end;
            position: sticky; top: 0px; z-index: 100;
        }
        
        #app2-wrapper #tutorial-sheet { 
            width: 794px; /* Ancho exacto A4 a 96DPI */
            height: 1123px; /* Alto exacto A4 a 96DPI */
            background: white; 
            padding: 85px; /* Margen seguro (aprox 2.1 cm) para que el texto encuadre a la perfecci√≥n */
            box-sizing: border-box; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); /* Sombra elegante para vista modal */
            border-radius: 4px;
        }
        #app2-wrapper .tut-card { 
            border: 1px solid #cbd5e1; 
            border-radius: 10px; 
            padding: 16px 20px; 
            background: #fff; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            box-sizing: border-box;
            margin-bottom: 12px; 
            width: 100%;
            word-wrap: break-word; /* Obliga al texto a no salir de sus bordes horizontales */
        }
        #app2-wrapper .tut-h3 { 
            font-size: 13px; /* Tama√±o de fuente √≥ptimo para espacio reducido */
            font-weight: 900; 
            color: var(--primary); 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 6px; 
            letter-spacing: 0.5px;
        }
        #app2-wrapper .tut-p { 
            font-size: 11px; /* Letra estilizada y segura contra recortes */
            line-height: 1.5; 
            margin: 0 0 6px 0; 
            color: #334155; 
            text-align: justify; /* Justificado profesional */
        }
        #app2-wrapper .tut-li { 
            font-size: 11px; 
            line-height: 1.5; 
            margin-bottom: 5px; 
            margin-left: 15px; 
            color: #334155; 
            text-align: justify;
        }
        #app2-wrapper .badge { 
            color: #1d4ed8; 
            background: #eff6ff; 
            padding: 3px 6px; 
            border-radius: 4px; 
            font-weight: 800; 
            border: 1px solid #bfdbfe; 
            font-size: 10px; 
        }
        #app2-wrapper .row-layout {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            width: 100%;
            box-sizing: border-box;
        }
        #app2-wrapper .col-50 {
            width: 48%; /* Mantiene espaciado natural sin empujar el margen derecho */
            margin-bottom: 0;
        }
    </style>
</head>
<body>

    <!-- M√≥dulo Oculto Extractor de Color -->
    <div id="colorExtractorModule" class="global-modal-overlay">
        <div style="background: white; padding: 20px; border-radius: 12px; max-width: 400px; display: flex; flex-direction: column; align-items: center; width: 100%;">
            <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #1e3a8a; font-family: sans-serif;">üì∏ Extractor de Color</h3>
                <button onclick="document.getElementById('colorExtractorModule').classList.remove('active')" style="background:none; border:none; font-size:18px; cursor:pointer;">‚ùå</button>
            </div>
            <span style="display:block; text-align:center; margin-bottom:10px; color:#64748b; font-size:12px; font-weight:bold; font-family: sans-serif;">Toque la imagen para extraer el color exacto de la mesa</span>
            <canvas id="extractorCanvas" style="max-width:300px; max-height:300px; border:1px dashed #94a3b8; cursor:crosshair; display:block; margin:0 auto;"></canvas>
            <input type="file" id="extractorInput" accept="image/*" style="display:none;">
        </div>
    </div>

    <!-- Modal Ayuda Slicers -->
    <div id="slicerHelpModule" class="global-modal-overlay">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; width: 100%;">
            <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                <h2 style="margin: 0; color: #2c3e50; font-family: sans-serif;">üìñ Gu√≠a de Uso: Generador de Slicers</h2>
                <button onclick="closeSlicerHelp()" style="background:none; border:none; font-size:24px; cursor:pointer; color: #c0392b;">&times;</button>
            </div>
            
            <div style="font-family: sans-serif; color: #333; font-size: 14px; line-height: 1.6;">
                <h4 style="color: #2980b9; margin-bottom: 5px;">1. Objetivo de Producci√≥n</h4>
                <p style="margin-top: 0;">Selecciona cu√°ntas tiras necesitas. Puedes usar los botones r√°pidos (Ej. 1 Mesa = 24 tiras). Tambi√©n escoge el tama√±o de tu mesa (10 pies, 9 pies, 8 pies) o elige una medida personalizada en pulgadas.</p>
                
                <h4 style="color: #2980b9; margin-bottom: 5px;">2. Formato de Salida</h4>
                <p style="margin-top: 0;">Elige si imprimir√°s en hojas sueltas (Paginado) o en un Plotter continuo (Rollo). Ajusta el tama√±o de papel de tu impresora y el sistema calcular√° cu√°ntas p√°ginas o metros necesitas autom√°ticamente.</p>
                
                <h4 style="color: #2980b9; margin-bottom: 5px;">3. Personalizaci√≥n y Autocontraste</h4>
                <ul style="margin-top: 0; padding-left: 20px;">
                    <li><strong>Etiqueta:</strong> Cambia el texto central para colocar el nombre de tu club.</li>
                    <li><strong>Color de Mesa:</strong> Puedes poner un color s√≥lido o usar el modo "Transparente". Si usas Transparente o Personalizado, aparecer√° un √≠cono de c√°mara (üì∏) para que subas una foto de tu mesa y extraigas su color exacto.</li>
                    <li><strong>üí° Autocontraste:</strong> Si ya capturaste el color de tu mesa, presiona este bot√≥n y el sistema buscar√° m√°gicamente colores para las l√≠neas, el diamante y el texto que contrasten perfectamente con la madera.</li>
                </ul>

                <h4 style="color: #2980b9; margin-bottom: 5px;">4. Descarga</h4>
                <p style="margin-top: 0;">Una vez est√©s conforme con la previsualizaci√≥n, haz clic en "Descargar PDF Final". Se generar√° un archivo vectorial de alta resoluci√≥n ideal para impresi√≥n profesional o corte l√°ser.</p>
            </div>
            
            <button onclick="closeSlicerHelp()" style="margin-top: 20px; background: #2c3e50; color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px;">Entendido</button>
        </div>
    </div>

    <!-- MEN√ö PRINCIPAL PARA ALTERNAR HERRAMIENTAS -->
    <div class="main-system-nav no-print">
        <button class="active" onclick="switchMainApp(event, 'app1')">Generador de Slicers</button>
        <button onclick="switchMainApp(event, 'app2')">StrokeMaster Pro</button>
    </div>

    <!-- ========================================================
         APLICACI√ìN 1: GENERADOR ABPC (GOLD MASTER)
         ======================================================== -->
    <div id="app1-wrapper" class="app-container active">
        <div class="main-panel">
            <div class="header">
                <h1>Generador De Slicers</h1>
                <div style="font-size:12px; color:#777; margin-top:5px;">Gold Master</div>
            </div>

            <!-- Previsualizaci√≥n con selector agregado -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; width: 100%;">
                <span class="live-label" style="margin-bottom: 0;">üëÅÔ∏è Previsualizaci√≥n del Dise√±o</span>
                <select id="previewSelect" onchange="updateLivePreview()" style="display:none; width: auto; padding: 4px; font-size: 11px; border-radius: 4px; border: 1px solid #bdc3c7;">
                    <option value="10">Mesa 10 Pies</option>
                    <option value="9">Mesa 9 Pies</option>
                    <option value="8">Mesa 8 Pies</option>
                </select>
            </div>
            <div class="live-preview-container" id="livePreviewContainer">
                <!-- SVG se inyectar√° aqu√≠ -->
            </div>

            <div class="controls-grid">
                <!-- GRUPO 1: PRODUCCI√ìN -->
                <div class="control-group">
                    <label>1. Objetivo de Producci√≥n</label>
                    <input type="number" id="totalStrips" value="72" min="1" onchange="updateCalc()">
                    <div class="quick-qty">
                        <button class="q-btn" id="btnTestQty" onclick="setQty(1)">PRUEBA (1)</button>
                        <button class="q-btn" onclick="setQty(24)">1 Mesa</button>
                        <button class="q-btn" onclick="setQty(48)">2 Mesas</button>
                        <button class="q-btn active" onclick="setQty(72)">3 Mesas</button>
                    </div>
                    <div style="margin-top:15px;">
                        <label>Medida de Mesa</label>
                        <select id="sizeType" onchange="updateCalc()">
                            <option value="mix">MIXTO (Configurable)</option>
                            <option value="10">Solo 10 Pies (14")</option>
                            <option value="9">Solo 9 Pies (12.5")</option>
                            <option value="8">Solo 8 Pies (11")</option>
                            <option value="custom">‚òÖ MEDIDA PERSONALIZADA</option>
                        </select>
                        <div id="customSizeContainer" class="custom-strip-input">
                            <label style="color:#d35400;">Distancia (Pulgadas):</label>
                            <input type="number" id="customVal" value="13.5" step="0.125" onchange="updateCalc()">
                        </div>
                    </div>
                </div>

                <!-- GRUPO 2: FORMATO -->
                <div class="control-group">
                    <label>2. Formato de Salida</label>
                    <div class="toggle-container">
                        <div class="toggle-btn active" id="btnSheet" onclick="setMode('sheet')">HOJAS (PAGINADO)</div>
                        <div class="toggle-btn" id="btnRoll" onclick="setMode('roll')">ROLLO (PLOTTER)</div>
                    </div>
                    
                    <div id="panelSheet">
                        <label>Tama√±o de Hoja</label>
                        <select id="paperStandard" onchange="handlePaperChange()">
                            <option value="tabloid" selected>Tabloide (11" x 17")</option>
                            <option value="superTabloid">Super Tabloide (12" x 18")</option>
                            <option value="a3">A3 (29.7cm x 42cm)</option>
                            <option value="a3plus">A3+ / Super B (33cm x 48cm)</option>
                            <option value="custom_sheet" style="color:#16a085; font-weight:bold;">‚òÖ TAMA√ëO PERSONALIZADO...</option>
                            <option value="letter" style="color:#c0392b;">Carta (11" x 8.5") - [PRUEBA]</option>
                            <option value="legal" style="color:#c0392b;">Oficio (14" x 8.5") - [PRUEBA]</option>
                        </select>
                        
                        <div id="customSheetContainer" class="custom-sheet-container">
                            <div class="custom-sheet-row">
                                <div style="flex:1;"><label>Ancho</label><input type="number" id="customSheetW" value="50" step="0.1" onchange="updateCalc()"></div>
                                <div style="flex:1;"><label>Alto</label><input type="number" id="customSheetH" value="35" step="0.1" onchange="updateCalc()"></div>
                                <div style="flex:0.6;"><label>Unidad</label><select id="customSheetUnit" onchange="updateCalc()"><option value="cm">cm</option><option value="in">in</option></select></div>
                            </div>
                        </div>
                    </div>

                    <div id="panelRoll" style="display:none;">
                        <label>Ancho del Rollo (cm)</label>
                        <input type="number" id="rollWidth" value="60" onchange="updateCalc()">
                        <small style="color:#888;">El largo se calcular√° autom√°ticamente.</small>
                    </div>
                    
                    <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                        <label>M√©todo de Corte</label>
                        <select id="cutStyle" onchange="updateCalc()" style="border: 2px solid #e74c3c;">
                            <option value="laser" selected>üõë L√≠nea Roja (L√°ser/Troquelado)</option>
                            <option value="scissors">‚úÇÔ∏è L√≠nea Gris (Manual)</option>
                        </select>
                    </div>
                </div>

                <!-- GRUPO 3: PERSONALIZACI√ìN -->
                <div class="control-group">
                    <label>3. Personalizaci√≥n</label>

                    <div style="margin-bottom:15px;">
                        <label>Etiqueta Central y Color</label>
                        <div style="display:flex; gap: 6px;">
                            <input type="text" id="labelText" value="ABPC" placeholder="Nombre del Club" onkeyup="updateCalc()" style="flex: 1; margin: 0;">
                            <input type="color" id="labelColor" value="#ffffff" onchange="window.isAutoContrast=false; updateCalc()" style="width: 60px; margin: 0;" title="Color del Texto">
                        </div>
                    </div>
                    
                    <!-- Color de L√≠neas y Contraste -->
                    <div style="margin-bottom:15px; border-bottom: 1px dashed #ccc; padding-bottom: 15px;">
                        <label>Color de L√≠neas</label>
                        <div style="display:flex; gap: 6px;">
                            <input type="color" id="lineColor" value="#00ffff" onchange="window.isAutoContrast=false; updateCalc()" style="flex: 1;">
                            <button class="btn-action" style="padding: 0 10px; margin: 0; background: #f59e0b; width: auto; font-size: 14px;" onclick="applyContrast()" title="Sugerir Color de Contraste Inteligente (YIQ)">üí° Autocontraste</button>
                        </div>
                    </div>

                    <label>Colores de Fondo (Mesa)</label>
                    
                    <!-- Single Color Mode -->
                    <div id="singleColorControl" style="display:flex; gap: 6px; align-items: center; margin-bottom: 10px;">
                        <select id="bgMode" onchange="updateCalc()" style="flex: 1;">
                            <option value="transparent" selected>Transparente</option>
                            <option value="black">Negro</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        <input type="color" id="colorGlobal" value="#3498db" onchange="updateCalc()" style="display:none; width: 60px;">
                        <button class="btn-action" id="btnCamGlobal" onclick="openExtractor('colorGlobal', () => { if(document.getElementById('bgMode').value !== 'transparent') document.getElementById('bgMode').value='custom'; updateCalc(); })" style="display:none; padding: 0 10px; margin: 0; background: #475569; width: auto;" title="Extraer Color de la Mesa">üì∏</button>
                    </div>

                    <!-- Mix Color Mode -->
                    <div id="mixColorControl" style="display:none;">
                        <div class="mix-row">
                            <label>10 Pies:</label>
                            <select id="bgMix10" onchange="updateCalc()">
                                <option value="transparent" selected>Transparente</option>
                                <option value="black">Negro</option>
                                <option value="custom">Personalizado</option>
                            </select>
                            <input type="color" id="colorMix10" value="#e74c3c" onchange="updateCalc()" style="display:none; width: 100%;">
                            <button class="btn-action" id="btnCamMix10" onclick="openExtractor('colorMix10', () => { if(document.getElementById('bgMix10').value !== 'transparent') document.getElementById('bgMix10').value='custom'; updateCalc(); })" style="display:none; padding: 0 10px; margin: 0; background: #475569; width: auto;" title="Extraer Color de la Mesa">üì∏</button>
                        </div>
                        <div class="mix-row">
                            <label>9 Pies:</label>
                            <select id="bgMix9" onchange="updateCalc()">
                                <option value="transparent">Transparente</option>
                                <option value="black">Negro</option>
                                <option value="custom">Personalizado</option>
                            </select>
                            <input type="color" id="colorMix9" value="#2ecc71" onchange="updateCalc()" style="display:none; width: 100%;">
                            <button class="btn-action" id="btnCamMix9" onclick="openExtractor('colorMix9', () => { if(document.getElementById('bgMix9').value !== 'transparent') document.getElementById('bgMix9').value='custom'; updateCalc(); })" style="display:none; padding: 0 10px; margin: 0; background: #475569; width: auto;" title="Extraer Color de la Mesa">üì∏</button>
                        </div>
                        <div class="mix-row">
                            <label>8 Pies:</label>
                            <select id="bgMix8" onchange="updateCalc()">
                                <option value="transparent">Transparente</option>
                                <option value="black">Negro</option>
                                <option value="custom" selected>Personalizado</option>
                            </select>
                            <input type="color" id="colorMix8" value="#3498db" onchange="updateCalc()" style="width: 100%;">
                            <button class="btn-action" id="btnCamMix8" onclick="openExtractor('colorMix8', () => { if(document.getElementById('bgMix8').value !== 'transparent') document.getElementById('bgMix8').value='custom'; updateCalc(); })" style="display:block; padding: 0 10px; margin: 0; background: #475569; width: auto;" title="Extraer Color de la Mesa">üì∏</button>
                        </div>
                    </div>

                    <!-- Color del Diamante -->
                    <div class="diamond-color-wrapper">
                        <label>Color del Diamante Central</label>
                        <input type="color" id="diamondColor" value="#FFD700" onchange="window.isAutoContrast=false; updateCalc()">
                    </div>
                </div> <!-- Termina Control Group 3 -->
            </div>

            <div class="info-box" id="statusMsg"></div>

            <button class="btn-action" onclick="generatePDF()">
                <span>‚¨á</span> Descargar PDF Final
            </button>
            
            <button class="btn-guide" onclick="generateGuidePDF()">
                <span>üìò</span> Descargar Gu√≠a de Instalaci√≥n
            </button>
            
            <button class="btn-guide" onclick="openSlicerHelp()" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%); margin-top: 15px;">
                <span>‚ùì</span> ¬øC√≥mo usar el Generador de Slicers?
            </button>
            
            <label style="margin-top:20px; font-weight:bold; color:white;">Previsualizaci√≥n de Lote:</label>
            <div class="visual-preview" id="previewGrid"></div>
        </div>

        <div class="footer-cr">
            Herramienta desarrollada por <strong>Juan Miguel Rios Redondo</strong><br>
            <span id="copyright-text"></span>
        </div>
    </div>


    <!-- ========================================================
         APLICACI√ìN 2: STROKEMASTER PRO
         ======================================================== -->
    <div id="app2-wrapper" class="app-container">
        <div class="header-container no-print">
            <h1 style="margin: 0; font-size: 26px; font-weight: 900; color: #1e3a8a;">STROKEMASTER PRO</h1>
            <p style="margin: 5px 0 15px 0; color: #64748b; font-size: 14px;"><em>"Precisi√≥n milim√©trica para el tiro perfecto."</em></p>
            <button class="btn-action btn-info" onclick="openTutorialModal()" style="margin: 0 auto;">üìÑ Ver Gu√≠a T√©cnica Detallada</button>
        </div>

        <!-- MODAL DE GUIA T√âCNICA -->
        <div id="tutorial-modal" class="modal-overlay">
            <div class="modal-content-wrapper">
                <div class="modal-toolbar">
                    <button class="btn-action btn-pdf" onclick="downloadTutorialPDF()">üíæ Guardar en PDF</button>
                    <button class="btn-action" style="background: #64748b; color: white;" onclick="closeTutorialModal()">‚ùå Cerrar</button>
                </div>
                
                <div id="tutorial-sheet">
                    <div style="border-bottom: 4px solid #2563eb; padding-bottom: 12px; margin-bottom: 20px; text-align: center;">
                        <h1 style="color: #1e3a8a; font-size: 24px; margin: 0; font-weight: 900; letter-spacing: 1px;">ESPECIFICACIONES T√âCNICAS Y MONTAJE</h1>
                        <p style="margin: 6px 0 0 0; font-weight: 800; color: #64748b; font-size: 11px; letter-spacing: 0.5px;">DOCUMENTO OFICIAL DE PRODUCCI√ìN - FORMATO DIN A4 (210 x 297 mm)</p>
                    </div>

                    <div class="tut-card">
                        <div class="tut-h3">1. Requisitos de Impresi√≥n y Hardware</div>
                        <ul style="margin:0; padding:0;">
                            <li class="tut-li"><strong>Regla de Oro:</strong> La impresi√≥n debe realizarse estrictamente al <strong style="color:red">100% de escala (Tama√±o Real)</strong>. Desactive ajustes como "Ajustar a p√°gina" o "Fit to printable area".</li>
                            <li class="tut-li"><strong>Modo de Color:</strong> Se recomienda utilizar perfil CMYK (FOGRA39) para garantizar la exactitud de los colores en medios f√≠sicos.</li>
                            <li class="tut-li"><strong>Maquinaria de Corte:</strong> El archivo vectorial A4 est√° optimizado para corte por l√°ser o plotter, usando las l√≠neas rojas discontinuas como vectores gu√≠a de corte.</li>
                        </ul>
                    </div>

                    <div class="row-layout">
                        <div class="tut-card col-50">
                            <div class="tut-h3">2. Materiales: Plantillas (Fichas)</div>
                            <p class="tut-p">Las fichas verticales requieren un material que no se combe. Recomendamos:</p>
                            <ul style="margin:0; padding:0;">
                                <li class="tut-li"><span class="badge">Acetato R√≠gido</span> (Grosor 250 - 300 micras).</li>
                                <li class="tut-li"><span class="badge">PETG Transparente</span> (1mm) impreso en cama plana UV.</li>
                            </ul>
                            <p class="tut-p" style="margin-top:10px;"><strong>Importante:</strong> El c√≠rculo central del objetivo debe quedar 100% transparente.</p>
                        </div>

                        <div class="tut-card col-50">
                            <div class="tut-h3">3. Materiales: Tapete y Bases</div>
                            <p class="tut-p"><strong>Tapete (60x25cm):</strong></p>
                            <ul style="margin:0; padding:0;">
                                <li class="tut-li">Ideal: <span class="badge">Neopreno 3mm</span> (tipo mousepad). Absorbe impactos.</li>
                                <li class="tut-li">Alternativa: <span class="badge">Lona Vin√≠lica 13oz</span> mate.</li>
                            </ul>
                            <p class="tut-p" style="margin-top:10px;"><strong>Bases (8x4cm):</strong> Cortar en Acr√≠lico Negro o Blanco de 3mm para estabilizar la ficha.</p>
                        </div>
                    </div>

                    <div class="tut-card">
                        <div class="tut-h3">4. Ensamblaje y Tolerancias de Fabricaci√≥n</div>
                        <ul style="margin:0; padding:0;">
                            <li class="tut-li"><strong>Corte Central:</strong> Utilice un comp√°s de corte o un bistur√≠ de precisi√≥n tipo X-Acto. Un agujero irregular generar√° fricci√≥n no deseada en el taco de billar.</li>
                            <li class="tut-li"><strong>Ranura de la Base (Slot):</strong> El rect√°ngulo interno de la base est√° marcado como gu√≠a. El operador debe ajustar el ancho del corte al grosor exacto del acetato o PETG utilizado (ej. 0.5mm, 1mm).</li>
                            <li class="tut-li"><strong>Limpieza:</strong> Lije suavemente los bordes del agujero central con lija de agua de grano fino para un deslizamiento fluido del taco.</li>
                        </ul>
                    </div>

                    <div style="margin-top: auto; border: 2px dashed #94a3b8; padding: 15px; border-radius: 10px; text-align: center; background-color: #f8fafc;">
                        <p style="font-weight: 900; font-size: 13px; margin-bottom: 15px; color: #1e293b; letter-spacing: 0.5px;">CONTROL DE CALIDAD - VERIFICACI√ìN DE ESCALA REAL</p>
                        <svg width="378" height="75" viewBox="0 0 100 20" style="max-width: 100%;">
                            <text x="50" y="6" text-anchor="middle" font-size="4" font-weight="900" font-family="Arial" fill="#334155">DISTANCIA EXACTA: 50.0 mm / 5.0 cm</text>
                            <line x1="25" y1="14" x2="75" y2="14" stroke="#000" stroke-width="1"/>
                            <line x1="25" y1="9" x2="25" y2="19" stroke="#000" stroke-width="1"/>
                            <line x1="75" y1="9" x2="75" y2="19" stroke="#000" stroke-width="1"/>
                        </svg>
                    </div>

                    <div style="margin-top: 15px; text-align: center; font-size: 10px; color: #94a3b8; font-weight: bold; border-top: 1px solid #e2e8f0; padding-top: 10px;">
                        DISE√ëADO POR JUAN MIGUEL RIOS REDONDO ¬© <span id="year-label">2026</span> - STROKEMASTER PRO
                    </div>
                </div>
            </div>
        </div>

        <!-- TABS INTERNOS -->
        <div class="tabs no-print">
            <button class="tab-btn active" onclick="switchAppTab(event, 'pack')">1. Pack Producci√≥n A4</button>
            <button class="tab-btn" onclick="switchAppTab(event, 'mat')">2. Tapete Profesional</button>
        </div>

        <!-- PACK A4 -->
        <div id="ws-pack" class="workspace active">
            <div class="controls no-print">
                <div class="control-group">
                    <span class="label">Color Tema</span>
                    <div style="display:flex; gap: 6px;">
                        <select id="packThemeSelect" onchange="syncPackColor()">
                            <option value="blue">Azul Oc√©ano</option>
                            <option value="green">Verde Billar</option>
                            <option value="dark">Carbono / Negro</option>
                            <option value="custom">Personalizado...</option>
                        </select>
                        <input type="color" id="packCustomColor" value="#29b6f6" oninput="setPackCustom()">
                    </div>
                </div>
                <div class="control-group">
                    <span class="label">Disciplina</span>
                    <select id="packMode" onchange="updatePack()">
                        <option value="pool">Pool (57.2mm)</option>
                        <option value="carom">3 Bandas (61.5mm)</option>
                    </select>
                </div>
                <div class="control-group">
                    <span class="label">Di√°metro √ò</span>
                    <select id="holeSize" onchange="updatePack()">
                        <option value="14">Experto (14mm)</option>
                        <option value="16" selected>Pro (16mm)</option>
                        <option value="18">Base (18mm)</option>
                    </select>
                </div>
                <button class="btn-action btn-pdf" onclick="downloadPDF('pack-sheet', 'StrokeMaster_Pro_Pack_A4.pdf')">üíæ Guardar Hoja A4</button>
            </div>

            <div id="pack-sheet" class="sheet-container" style="width: 210mm; height: 296mm;">
                <svg width="210mm" height="296mm" viewBox="0 0 210 296" xmlns="http://www.w3.org/2000/svg">
                    <defs id="svgDefs">
                        <radialGradient id="gradPack" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                            <stop offset="25%" style="stop-color:#e0f7fa;stop-opacity:0.2" id="stop1" />
                            <stop offset="70%" style="stop-color:#29b6f6;stop-opacity:0.6" id="stop2" />
                            <stop offset="100%" style="stop-color:#0277bd;stop-opacity:0.9" id="stop3" />
                        </radialGradient>
                    </defs>
                    
                    <text x="105" y="8" text-anchor="middle" font-family="Arial" font-size="2.5" font-weight="900" fill="#94a3b8">PLANTILLAS DE CORTE - PACK COMPLETO S/M/L</text>
                    <text x="105" y="11.5" text-anchor="middle" font-family="Arial" font-size="2" fill="#cbd5e1">A4 (210 x 297 mm) | CROP MARKS ENABLED</text>

                    <!-- MARCAS DE REGISTRO (ESQUINAS) -->
                    <g class="reg-mark" fill="none" stroke="#333" stroke-width="0.5">
                        <path d="M 5,5 L 15,5 M 5,5 L 5,15" fill="none"/> <path d="M 205,5 L 195,5 M 205,5 L 205,15" fill="none"/>
                        <path d="M 5,291 L 15,291 M 5,291 L 5,281" fill="none"/> <path d="M 205,291 L 195,291 M 205,291 L 205,281" fill="none"/>
                    </g>

                    <g transform="translate(15, 15)"><text x="40" y="-2" text-anchor="middle" font-size="3" fill="#666" font-weight="bold">FICHA S</text><g id="packSightS"></g></g>
                    <g transform="translate(115, 15)"><text x="40" y="-2" text-anchor="middle" font-size="3" fill="#666" font-weight="bold">FICHA M</text><g id="packSightM"></g></g>
                    <g transform="translate(15, 125)"><text x="40" y="-2" text-anchor="middle" font-size="3" fill="#666" font-weight="bold">FICHA L</text><g id="packSightL"></g></g>

                    <g transform="translate(115, 130)"><g id="packBaseS"></g></g>
                    <g transform="translate(15, 235)"><g id="packBaseM"></g></g>
                    <g transform="translate(115, 235)"><g id="packBaseL"></g></g>

                    <g transform="translate(105, 288)">
                        <path d="M -25,0 L 25,0 M -25,0 L -25,-2 M 25,0 L 25,-2" stroke="black" stroke-width="0.5"/>
                        <text x="0" y="-4" text-anchor="middle" font-size="3" font-family="Arial" font-weight="900">CALIBRACI√ìN: 50.0 mm</text>
                    </g>

                    <text x="105" y="294" text-anchor="middle" font-family="Arial" font-size="1.8" fill="#cbd5e1" font-weight="bold">DISE√ëADO POR JUAN MIGUEL RIOS REDONDO - STROKEMASTER PRO</text>
                </svg>
            </div>
        </div>

        <!-- TAPETE -->
        <div id="ws-mat" class="workspace">
            <div class="controls no-print">
                <div class="control-group">
                    <span class="label">Personalizaci√≥n (Nombre)</span>
                    <input type="text" id="customName" placeholder="CLUB / JUGADOR" oninput="updateMat()" maxlength="25">
                </div>
                <div class="control-group">
                    <span class="label">Color Tapete</span>
                    <div style="display:flex; gap: 6px;">
                        <select id="matThemeSelect" onchange="syncMatColor()">
                            <option value="blue">Azul Cl√°sico</option>
                            <option value="green">Verde Billar</option>
                            <option value="dark">Negro Carb√≥n</option>
                            <option value="custom">Personalizado...</option>
                        </select>
                        <input type="color" id="matCustomColor" value="#2563eb" oninput="setMatCustom()">
                    </div>
                </div>
                <button class="btn-action btn-pdf" onclick="downloadPDF('mat-sheet', 'StrokeMaster_Pro_Tapete_60x25.pdf')">üíæ Guardar Tapete (PDF)</button>
            </div>

            <div id="mat-sheet" class="sheet-container" style="width: 250mm; height: 599mm;">
                <svg width="250mm" height="599mm" viewBox="0 0 250 599" xmlns="http://www.w3.org/2000/svg">
                    <rect id="matBg" width="250" height="599" fill="#2563eb" rx="5" />
                    <rect x="0" y="450" width="250" height="149" fill="rgba(255,255,255,0.1)" />
                    <rect x="117.5" y="50" width="15" height="500" fill="#ccff00" opacity="0.9" />
                    <rect x="117.5" y="550" width="15" height="20" fill="black" /> 
                    <g transform="translate(125, 520)">
                        <text x="0" y="0" text-anchor="middle" font-family="Roboto" font-weight="900" font-size="14" fill="white" opacity="0.8">BRIDGE ZONE</text>
                        <circle cx="0" cy="35" r="12" fill="none" stroke="white" stroke-width="2" opacity="0.6"/>
                        <circle cx="0" cy="35" r="4" fill="white" opacity="0.8"/>
                        <text id="matLogoText" x="0" y="62" text-anchor="middle" font-family="Roboto" font-weight="900" font-size="9" fill="white" letter-spacing="1">STROKEMASTER PRO</text>
                    </g>
                    <line x1="20" y1="450" x2="230" y2="450" stroke="white" stroke-width="0.5" stroke-dasharray="2 2" opacity="0.4"/>
                    <text x="50" y="400" text-anchor="middle" class="zone-label" font-size="18" transform="rotate(-90, 50, 400)">SHORT STROKE</text>
                    <text x="200" y="400" text-anchor="middle" class="zone-label" font-size="18" transform="rotate(90, 200, 400)">SHORT STROKE</text>
                    <line x1="20" y1="300" x2="230" y2="300" stroke="white" stroke-width="0.5" stroke-dasharray="2 2" opacity="0.4"/>
                    <text x="50" y="225" text-anchor="middle" class="zone-label" font-size="18" transform="rotate(-90, 50, 225)">MEDIUM STROKE</text>
                    <text x="200" y="225" text-anchor="middle" class="zone-label" font-size="18" transform="rotate(90, 200, 225)">MEDIUM STROKE</text>
                    <line x1="20" y1="150" x2="230" y2="150" stroke="white" stroke-width="0.5" stroke-dasharray="2 2" opacity="0.4"/>
                    <text x="50" y="75" text-anchor="middle" class="zone-label" font-size="18" transform="rotate(-90, 50, 75)">LONG STROKE</text>
                    <text x="200" y="75" text-anchor="middle" class="zone-label" font-size="18" transform="rotate(90, 200, 75)">LONG STROKE</text>
                    <g id="matMarkers"></g>
                    <g stroke="white" stroke-width="0.5" opacity="0.7">
                        <line x1="25" y1="450" x2="25" y2="50" />
                        <line x1="225" y1="450" x2="225" y2="50" />
                    </g>
                    <g id="matRulerTicks"></g>
                </svg>
            </div>
        </div>
    </div>

    <!-- SCRIPT GENERAL PARA AMBAS APLICACIONES -->
    <script>
        /* =========================================
           NAVEGACI√ìN PRINCIPAL
           ========================================= */
        function switchMainApp(e, appId) {
            document.querySelectorAll('.app-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.main-system-nav button').forEach(el => el.classList.remove('active'));
            document.getElementById(appId + '-wrapper').classList.add('active');
            e.currentTarget.classList.add('active');
        }

        /* =========================================
           C√ìDIGO APP 1: GENERADOR ABPC (GOLD)
           ========================================= */
        document.getElementById('year-label').innerText = new Date().getFullYear();
        document.getElementById('copyright-text').innerText = "¬© " + new Date().getFullYear();

        window.isAutoContrast = false;

        let mode = 'sheet'; 
        const STRIP_H = 1.40; 
        const GAP_Y = 0.2; 
        const MARGIN = 0.3;
        const LINE_WIDTH_MAX = 0.12; 
        const DIAMOND_RADIUS = 0.50; 
        
        let calc = { paperW: 0, paperH: 0, cols: 0, rowsPerPage: 0, totalPages: 0, stripsPerPage: 0, stripsToPrint: [] };

        function setQty(n) {
            document.getElementById('totalStrips').value = n;
            document.querySelectorAll('#app1-wrapper .q-btn').forEach(b => {
                b.classList.remove('active');
                if (b.getAttribute('onclick').includes(`(${n})`)) {
                    b.classList.add('active');
                }
            });
            updateCalc();
        }

        function handlePaperChange() {
            const pt = document.getElementById('paperStandard').value;
            const btnTest = document.getElementById('btnTestQty');
            const customContainer = document.getElementById('customSheetContainer');
            
            customContainer.style.display = (pt === 'custom_sheet') ? 'block' : 'none';

            if (pt === 'letter' || pt === 'legal') {
                btnTest.style.display = 'inline-block';
                setQty(1);
            } else {
                btnTest.style.display = 'none';
                if (parseInt(document.getElementById('totalStrips').value) === 1) {
                    setQty(24);
                } else {
                    updateCalc();
                }
            }
        }

        function setMode(m) {
            mode = m;
            document.getElementById('btnSheet').className = m === 'sheet' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('btnRoll').className = m === 'roll' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('panelSheet').style.display = m === 'sheet' ? 'block' : 'none';
            document.getElementById('panelRoll').style.display = m === 'roll' ? 'block' : 'none';
            
            if(m === 'sheet') {
                handlePaperChange(); 
            } else {
                document.getElementById('btnTestQty').style.display = 'none';
                if (parseInt(document.getElementById('totalStrips').value) === 1) {
                    setQty(24);
                } else {
                    updateCalc();
                }
            }
        }

        function resolveColor(selectId, inputId, camId) {
            const mode = document.getElementById(selectId).value;
            const input = document.getElementById(inputId);
            const cam = document.getElementById(camId);
            if (mode === 'custom' || mode === 'transparent') {
                input.style.display = 'block';
                if(cam) cam.style.display = 'block';
                return { mode: mode, val: input.value };
            } else {
                input.style.display = 'none';
                if(cam) cam.style.display = 'none';
                return { mode: mode, val: null };
            }
        }

        function updateCalc() {
            const qty = parseInt(document.getElementById('totalStrips').value) || 24;
            const type = document.getElementById('sizeType').value;
            const customInput = document.getElementById('customSizeContainer');
            customInput.style.display = (type === 'custom') ? 'block' : 'none';
            
            const isMix = (type === 'mix');
            document.getElementById('singleColorControl').style.display = isMix ? 'none' : 'flex';
            document.getElementById('mixColorControl').style.display = isMix ? 'block' : 'none';
            document.getElementById('previewSelect').style.display = isMix ? 'block' : 'none';

            const colGlobal = resolveColor('bgMode', 'colorGlobal', 'btnCamGlobal');
            const col10 = resolveColor('bgMix10', 'colorMix10', 'btnCamMix10');
            const col9 = resolveColor('bgMix9', 'colorMix9', 'btnCamMix9');
            const col8 = resolveColor('bgMix8', 'colorMix8', 'btnCamMix8');

            calc.stripsToPrint = [];
            if (type === 'mix') {
                const base = Math.floor(qty / 3);
                let rem = qty % 3;
                for(let i=0; i < base + (rem>0?1:0); i++) calc.stripsToPrint.push({w:14.0, l:"10 Pies", colorCfg: col10});
                for(let i=0; i < base + (rem>1?1:0); i++) calc.stripsToPrint.push({w:12.5, l:"9 Pies", colorCfg: col9});
                for(let i=0; i < base; i++) calc.stripsToPrint.push({w:11.0, l:"8 Pies", colorCfg: col8});
            } else {
                let s = 14.0, l = "10 Pies";
                if(type==='9'){s=12.5; l="9 Pies";}
                if(type==='8'){s=11.0; l="8 Pies";}
                if(type==='custom') {
                    s = parseFloat(document.getElementById('customVal').value) || 12.0;
                    l = `Medida: ${s}"`;
                }
                for(let i=0; i<qty; i++) calc.stripsToPrint.push({w:s, l:l, colorCfg: colGlobal});
            }

            if (mode === 'sheet') {
                const pt = document.getElementById('paperStandard').value;
                if(pt==='letter') { calc.paperW=11; calc.paperH=8.5; }
                else if(pt==='legal') { calc.paperW=14; calc.paperH=8.5; }
                else if(pt==='tabloid') { calc.paperW=17; calc.paperH=11; }
                else if(pt==='superTabloid') { calc.paperW=18; calc.paperH=12; }
                else if(pt==='a3') { calc.paperW=16.54; calc.paperH=11.69; }
                else if(pt==='a3plus') { calc.paperW=19; calc.paperH=13; }
                else if(pt==='custom_sheet') {
                    const w = parseFloat(document.getElementById('customSheetW').value) || 10;
                    const h = parseFloat(document.getElementById('customSheetH').value) || 10;
                    const unit = document.getElementById('customSheetUnit').value;
                    if(unit === 'cm') { calc.paperW = w / 2.54; calc.paperH = h / 2.54; } 
                    else { calc.paperW = w; calc.paperH = h; }
                }
            } else {
                const wCm = parseFloat(document.getElementById('rollWidth').value) || 60;
                calc.paperW = wCm / 2.54;
            }

            let maxStripW = 0;
            calc.stripsToPrint.forEach(s => { if(s.w > maxStripW) maxStripW = s.w; });
            const colWidth = maxStripW + 0.2; 
            
            const rowHeight = STRIP_H + GAP_Y;
            const usableW = calc.paperW - (MARGIN*2);
            
            calc.cols = Math.floor(usableW / colWidth);
            if(calc.cols < 1) calc.cols = 1; 

            if (mode === 'sheet') {
                const usableH = calc.paperH - (MARGIN*2) - 0.5;
                calc.rowsPerPage = Math.floor(usableH / rowHeight);
                calc.stripsPerPage = calc.cols * calc.rowsPerPage;
                if(calc.stripsPerPage < 1) calc.stripsPerPage = 1; 
                calc.totalPages = Math.ceil(qty / calc.stripsPerPage);
            } else {
                const totalRows = Math.ceil(qty / calc.cols);
                calc.paperH = (totalRows * rowHeight) + (MARGIN*2) + 1.0;
                calc.rowsPerPage = totalRows;
                calc.totalPages = 1;
            }

            const status = document.getElementById('statusMsg');
            const wCm = (calc.paperW * 2.54).toFixed(1);
            const hCm = (calc.paperH * 2.54).toFixed(1);
            
            const cutStyle = document.getElementById('cutStyle').value;
            const cutMsg = cutStyle === 'laser' ? "L√ÅSER (ROJO)" : "MANUAL (GRIS)";

            if(mode === 'sheet') {
                let note = "";
                const pt = document.getElementById('paperStandard').value;
                if(pt === 'letter' || pt === 'legal') {
                    note = "<br><span style='color:#c0392b;'>‚ö†Ô∏è MODO PRUEBA VISUAL: La tira saldr√° cortada.</span>";
                }
                status.innerHTML = `<strong>Producci√≥n Paginada:</strong> ${calc.totalPages} p√°ginas (${wCm}x${hCm}cm).<br>Capacidad por hoja: ${calc.stripsPerPage} tiras. | Estilo: ${cutMsg}${note}`;
            } else {
                status.innerHTML = `<strong>Producci√≥n en Rollo:</strong> Archivo √∫nico de ${wCm}cm x ${hCm}cm. | Estilo: ${cutMsg}`;
            }

            updateLivePreview();
        }

        function updateLivePreview() {
            const container = document.getElementById('livePreviewContainer');
            const type = document.getElementById('sizeType').value;
            
            let strip = calc.stripsToPrint[0] || {w:14, l:"10 Pies", colorCfg:{mode:'black'}};
            
            if (type === 'mix') {
                const pVal = document.getElementById('previewSelect').value;
                const labelTarget = pVal + " Pies";
                strip = calc.stripsToPrint.find(s => s.l === labelTarget) || strip;
            }
            
            const theme = getColorTheme(strip.colorCfg);
            
            // Sincronizamos los inputs visuales con la previsualizaci√≥n actual si el autocontraste est√° encendido
            if (window.isAutoContrast) {
                document.getElementById('lineColor').value = "#" + ("000000" + rgbToHexVal(theme.line[0], theme.line[1], theme.line[2])).slice(-6);
                document.getElementById('diamondColor').value = "#" + ("000000" + rgbToHexVal(theme.gold[0], theme.gold[1], theme.gold[2])).slice(-6);
                document.getElementById('labelColor').value = "#" + ("000000" + rgbToHexVal(theme.txt[0], theme.txt[1], theme.txt[2])).slice(-6);
            }
            
            const labelTxt = document.getElementById('labelText').value;
            
            const fill = theme.fill ? `rgb(${theme.fill.join(',')})` : 'none';
            const stroke = theme.fill ? 'none' : '#333';
            const line = `rgb(${theme.line.join(',')})`;
            const gold = `rgb(${theme.gold.join(',')})`;
            const txt = `rgb(${theme.txt.join(',')})`;
            
            const w = strip.w;
            const h = STRIP_H;
            
            let ticks = "";
            const step = w/10;
            for(let t=1; t<10; t++) {
                if(t===5) continue;
                let tx = step*t;
                ticks += `<line x1="${tx}" y1="${h/2 - 0.3}" x2="${tx}" y2="${h/2 + 0.3}" stroke="${line}" stroke-width="${LINE_WIDTH_MAX}" />`;
            }

            const svg = `
            <svg width="100%" height="auto" viewBox="0 0 ${w} ${h}" style="border:1px solid #ccc; display: block; margin: 0 auto;">
                <rect x="0" y="0" width="${w}" height="${h}" fill="${fill}" stroke="${stroke}" stroke-width="0.02"/>
                <line x1="0" y1="${h/2}" x2="${w}" y2="${h/2}" stroke="${line}" stroke-width="0.04" />
                ${ticks}
                <polygon points="${w/2},${h/2-DIAMOND_RADIUS} ${w/2+DIAMOND_RADIUS},${h/2} ${w/2},${h/2+DIAMOND_RADIUS} ${w/2-DIAMOND_RADIUS},${h/2}" fill="${gold}"/>
                <text x="${w/2}" y="${h-0.08}" font-family="Arial" font-weight="bold" font-size="0.14" fill="${txt}" text-anchor="middle">${labelTxt}</text>
            </svg>`;
            
            container.innerHTML = svg;
        }

        function hexToRgb(hex) {
            let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : [0, 0, 0];
        }

        function rgbToHexVal(r, g, b) {
            return ((r << 16) | (g << 8) | b).toString(16);
        }

        function isDark(rgb) {
            const brightness = Math.round(((parseInt(rgb[0]) * 299) + (parseInt(rgb[1]) * 587) + (parseInt(rgb[2]) * 114)) / 1000);
            return brightness < 125;
        }

        function getColorTheme(cfg) {
            let cLine = hexToRgb(document.getElementById('lineColor').value);
            let cDiamond = hexToRgb(document.getElementById('diamondColor').value);
            let cText = hexToRgb(document.getElementById('labelColor').value);
            
            let bgHex = cfg.val;
            if (cfg.mode === 'black') bgHex = '#000000';
            else if (!bgHex) bgHex = '#ffffff';

            let bgRgb = hexToRgb(bgHex);
            let isDarkBg = isDark(bgRgb);

            if (window.isAutoContrast) {
                const yiq = ((bgRgb[0] * 299) + (bgRgb[1] * 587) + (bgRgb[2] * 114)) / 1000;
                if (yiq < 128) { 
                    cLine = hexToRgb(darkPalettes[contrastIndexDark % darkPalettes.length]);
                    cDiamond = hexToRgb(darkPalettes[(contrastIndexDark + 1) % darkPalettes.length]);
                    cText = hexToRgb(darkPalettes[(contrastIndexDark + 2) % darkPalettes.length]);
                } else {         
                    cLine = hexToRgb(lightPalettes[contrastIndexLight % lightPalettes.length]);
                    cDiamond = hexToRgb(lightPalettes[(contrastIndexLight + 1) % lightPalettes.length]);
                    cText = hexToRgb(lightPalettes[(contrastIndexLight + 2) % lightPalettes.length]);
                }
            }

            if (cfg.mode === 'transparent') {
                return { fill: null, txt: cText, line: cLine, gold: cDiamond };
            }
            if (cfg.mode === 'black') {
                return { fill: [15, 15, 15], txt: cText, line: cLine, gold: cDiamond };
            }
            return { fill: bgRgb, txt: cText, line: cLine, gold: cDiamond };
        }

        /* =========================================
           EXTRACTOR DE COLOR FOTOGR√ÅFICO Y AYUDA
           ========================================= */
        let activeColorTarget = null;
        let activeColorCallback = null;

        function openExtractor(inputId, callback) {
            activeColorTarget = inputId;
            activeColorCallback = callback;
            document.getElementById('extractorInput').click();
        }

        document.getElementById('extractorInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('extractorCanvas');
                    const ctx = canvas.getContext('2d');
                    let w = img.width;
                    let h = img.height;
                    if (w > 300) { h = (300 / w) * h; w = 300; }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    document.getElementById('colorExtractorModule').classList.add('active');
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        document.getElementById('extractorCanvas').addEventListener('click', function(e) {
            if(!activeColorTarget) return;
            const rect = this.getBoundingClientRect();
            const scaleX = this.width / rect.width;
            const scaleY = this.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            const ctx = this.getContext('2d');
            const pixel = ctx.getImageData(x, y, 1, 1).data;
            const hex = "#" + ("000000" + rgbToHexVal(pixel[0], pixel[1], pixel[2])).slice(-6);
            
            document.getElementById(activeColorTarget).value = hex;
            document.getElementById('colorExtractorModule').classList.remove('active');
            
            if(activeColorCallback) activeColorCallback();
        });

        function openSlicerHelp() {
            document.getElementById('slicerHelpModule').classList.add('active');
        }

        function closeSlicerHelp() {
            document.getElementById('slicerHelpModule').classList.remove('active');
        }

        /* =========================================
           MOTOR DE CONTRASTE YIQ (SLICER)
           ========================================= */
        const darkPalettes = ['#00ffff', '#fbbf24', '#34d399', '#f472b6', '#a3e635']; 
        const lightPalettes = ['#000000', '#1e3a8a', '#064e3b', '#7f1d1d', '#4c1d95']; 
        let contrastIndexDark = 0;
        let contrastIndexLight = 0;

        function applyContrast() {
            window.isAutoContrast = true;
            contrastIndexDark++;
            contrastIndexLight++;
            updateCalc();
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const orientation = calc.paperW > calc.paperH ? 'l' : 'p';
            const doc = new jsPDF({ orientation, unit: 'in', format: [calc.paperW, calc.paperH] });
            const labelTxt = document.getElementById('labelText').value;
            const cutStyle = document.getElementById('cutStyle').value; 

            let cursorX = MARGIN; let cursorY = 1.0; let itemsOnPage = 0; let colIdx = 0;
            
            let maxStripW = 0;
            calc.stripsToPrint.forEach(s => { if(s.w > maxStripW) maxStripW = s.w; });
            const colW = maxStripW + 0.2;

            const addFooter = (pNum) => { doc.setFontSize(8); doc.setTextColor(150); doc.text(`Desarrollado por Juan Miguel Rios Redondo - P√°g ${pNum}`, MARGIN, calc.paperH - 0.2); };
            const addHeader = (txt) => {
                 doc.setFontSize(14); doc.setTextColor(0); doc.text(txt, calc.paperW/2, 0.5, {align:'center'});
                 if (cutStyle === 'laser') {
                     doc.setFontSize(10); doc.setTextColor(231, 76, 60); 
                     doc.text("‚ö†Ô∏è NOTA T√âCNICA: L√≠nea ROJA (RGB 255,0,0) es TRAZO DE CORTE.", calc.paperW/2, 0.7, {align:'center'});
                 }
            };

            addHeader(`ORDEN DE PRODUCCI√ìN ABPC - ${calc.stripsToPrint.length} UNIDADES`);
            addFooter(1);

            calc.stripsToPrint.forEach((strip, i) => {
                if (mode === 'sheet' && itemsOnPage >= calc.stripsPerPage) {
                    doc.addPage();
                    cursorX = MARGIN; cursorY = 1.0; itemsOnPage = 0; colIdx = 0;
                    addHeader("CONTINUACI√ìN"); addFooter(doc.internal.getNumberOfPages());
                }

                const theme = getColorTheme(strip.colorCfg);
                drawStripVector(doc, cursorX, cursorY, strip.w, STRIP_H, strip.l, labelTxt, theme, cutStyle);

                colIdx++; itemsOnPage++;
                if (colIdx >= calc.cols) { colIdx = 0; cursorX = MARGIN; cursorY += (STRIP_H + GAP_Y); } 
                else { cursorX += colW; }
            });

            doc.save(`Slicers_JMRR_MAX_${calc.stripsToPrint.length}.pdf`);
        }

        function drawStripVector(doc, x, y, w, h, subLabel, mainLabel, theme, cutStyle) {
            if(theme.fill) { doc.setFillColor(theme.fill[0], theme.fill[1], theme.fill[2]); doc.rect(x, y, w, h, 'F'); }
            if (cutStyle === 'laser') { doc.setDrawColor(255, 0, 0); doc.setLineWidth(0.005); doc.rect(x, y, w, h, 'S'); } 
            else if (cutStyle === 'scissors') { doc.setDrawColor(150); doc.setLineWidth(0.01); doc.setLineDash([0.1, 0.1]); doc.rect(x, y, w, h, 'S'); doc.setLineDash([]); }

            doc.setDrawColor(theme.line[0], theme.line[1], theme.line[2]); doc.setLineWidth(0.04); doc.line(x, y+h/2, x+w, y+h/2);

            const step = w/10;
            doc.setLineWidth(LINE_WIDTH_MAX); 
            for(let t=1; t<10; t++) {
                if(t===5) continue;
                let tx = x + (step*t);
                doc.line(tx, y + h/2 - 0.3, tx, y + h/2 + 0.3);
            }

            doc.setFillColor(theme.gold[0], theme.gold[1], theme.gold[2]);
            const cx = x + w/2; const cy = y + h/2; const dR = DIAMOND_RADIUS; 
            doc.triangle(cx, cy-dR, cx+dR, cy, cx-dR, cy, 'F');
            doc.triangle(cx, cy+dR, cx+dR, cy, cx-dR, cy, 'F');

            doc.setTextColor(theme.txt[0], theme.txt[1], theme.txt[2]);
            doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.text(mainLabel, cx, y + h - 0.08, {align:'center'});

            doc.setFontSize(9); doc.setTextColor(100); doc.text(subLabel, x + 0.1, y + 0.15);
            
            const endSize = 0.30; doc.setFillColor(theme.line[0], theme.line[1], theme.line[2]);
            doc.triangle(x, y+h/2-endSize, x+endSize, y+h/2, x, y+h/2, 'F'); doc.triangle(x, y+h/2+endSize, x+endSize, y+h/2, x, y+h/2, 'F');
            doc.triangle(x+w, y+h/2-endSize, x+w-endSize, y+h/2, x+w, y+h/2, 'F'); doc.triangle(x+w, y+h/2+endSize, x+w-endSize, y+h/2, x+w, y+h/2, 'F');
        }

        async function generateGuidePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'in', format: 'letter' });
            const m = 0.8; let y = 1.0;

            doc.setFont("helvetica", "bold"); doc.setFontSize(24); doc.setTextColor(44, 62, 80);
            doc.text("GU√çA DE INSTALACI√ìN", doc.internal.pageSize.getWidth()/2, y, {align:'center'}); y += 0.3;
            doc.setFontSize(14); doc.setTextColor(127, 140, 141);
            doc.text("SISTEMA DE PRECISI√ìN PARA BILLAR", doc.internal.pageSize.getWidth()/2, y, {align:'center'});
            y += 0.5; doc.setLineWidth(0.02); doc.setDrawColor(230, 126, 34); doc.line(m, y, doc.internal.pageSize.getWidth()-m, y); y += 0.5;

            doc.setFont("helvetica", "bold"); doc.setFontSize(16); doc.setTextColor(44, 62, 80); doc.text("1. PREPARACI√ìN DE LA SUPERFICIE", m, y); y+=0.3;
            doc.setFont("helvetica", "normal"); doc.setFontSize(12); doc.setTextColor(50);
            doc.text("‚Ä¢ Limpie la superficie de la banda con alcohol isoprop√≠lico para eliminar", m + 0.3, y); y+=0.25;
            doc.text("  cualquier rastro de grasa, tiza o polvo.", m + 0.3, y); y+=0.25;
            doc.text("‚Ä¢ Aseg√∫rese de que la madera est√© completamente seca antes de continuar.", m + 0.3, y); y+=0.6;

            doc.setFont("helvetica", "bold"); doc.setFontSize(16); doc.setTextColor(44, 62, 80); doc.text("2. ALINEACI√ìN PRECISA", m, y); y+=0.3;
            doc.setFont("helvetica", "normal"); doc.setFontSize(12); doc.setTextColor(50);
            doc.text("‚Ä¢ Localice el diamante de n√°car original incrustado en la mesa.", m + 0.3, y); y+=0.25;
            doc.text("‚Ä¢ Presente la tira sin quitar el adhesivo.", m + 0.3, y); y+=0.25;
            doc.text("‚Ä¢ El DIAMANTE GRANDE impreso debe quedar perfectamente centrado", m + 0.3, y); y+=0.25;
            doc.text("  sobre el diamante real de la mesa.", m + 0.3, y); y+=0.6;

            doc.setFont("helvetica", "bold"); doc.setFontSize(16); doc.setTextColor(44, 62, 80); doc.text("3. APLICACI√ìN PROFESIONAL", m, y); y+=0.3;
            doc.setFont("helvetica", "normal"); doc.setFontSize(12); doc.setTextColor(50);
            doc.text("‚Ä¢ Retire el papel protector comenzando desde el centro.", m + 0.3, y); y+=0.25;
            doc.text("‚Ä¢ Pegue primero la zona central y presione suavemente hacia los extremos.", m + 0.3, y); y+=0.25;
            doc.text("‚Ä¢ Use un pa√±o suave para frotar firmemente y asegurar la adherencia total.", m + 0.3, y); 
            
            doc.setFontSize(10); doc.setTextColor(150);
            const pageHeight = doc.internal.pageSize.getHeight();
            doc.text("Desarrollado por Juan Miguel Rios Redondo ¬© " + new Date().getFullYear(), doc.internal.pageSize.getWidth()/2, pageHeight - 0.5, {align:'center'});

            doc.save("Guia_Instalacion_Slicers.pdf");
        }
        updateCalc(); // Iniciar app 1


        /* =========================================
           C√ìDIGO APP 2: STROKEMASTER PRO
           ========================================= */
        const themesPack = {
            blue: { s1: '#e0f7fa', s2: '#29b6f6', s3: '#0277bd' },
            green: { s1: '#f1f8e9', s2: '#66bb6a', s3: '#2e7d32' },
            dark: { s1: '#f8fafc', s2: '#475569', s3: '#0f172a' }
        };

        function getShadesFromHex(hex) {
            let rgb = hexToRgb(hex); // Utiliza el mismo hexToRgb de la app 1
            let r1 = Math.round(rgb[0] + (255 - rgb[0]) * 0.8);
            let g1 = Math.round(rgb[1] + (255 - rgb[1]) * 0.8);
            let b1 = Math.round(rgb[2] + (255 - rgb[2]) * 0.8);
            let r3 = Math.round(rgb[0] * 0.6);
            let g3 = Math.round(rgb[1] * 0.6);
            let b3 = Math.round(rgb[2] * 0.6);
            return { s1: `rgb(${r1},${g1},${b1})`, s2: hex, s3: `rgb(${r3},${g3},${b3})` };
        }

        function syncPackColor() {
            const select = document.getElementById('packThemeSelect').value;
            const picker = document.getElementById('packCustomColor');
            if (select === 'blue') picker.value = '#29b6f6';
            else if (select === 'green') picker.value = '#66bb6a';
            else if (select === 'dark') picker.value = '#475569';
            updatePack();
        }
        function setPackCustom() { document.getElementById('packThemeSelect').value = 'custom'; updatePack(); }

        function syncMatColor() {
            const select = document.getElementById('matThemeSelect').value;
            const picker = document.getElementById('matCustomColor');
            if (select === 'blue') picker.value = '#2563eb';
            else if (select === 'green') picker.value = '#065f46';
            else if (select === 'dark') picker.value = '#1e293b';
            updateMat();
        }
        function setMatCustom() { document.getElementById('matThemeSelect').value = 'custom'; updateMat(); }

        function getSightSVG(gradientId, holeDiameter) {
            let clockHtml = '';
            const radius = 26; const midRadius = 16; const innerRadius = 8;
            const holeRadius = holeDiameter / 2;

            for (let i = 1; i <= 12; i++) {
                const angle = (i * 30 - 90) * (Math.PI / 180);
                const x = radius * Math.cos(angle); const y = radius * Math.sin(angle);
                const dx = midRadius * Math.cos(angle); const dy = midRadius * Math.sin(angle);
                
                clockHtml += `<line x1="0" y1="0" x2="${x}" y2="${y}" stroke="black" stroke-width="0.08" opacity="0.4" fill="none"/>`;
                clockHtml += `<circle cx="${dx}" cy="${dy}" r="0.7" fill="black"/>`;
                clockHtml += `<circle cx="${x}" cy="${y}" r="2.8" fill="white" stroke="black" stroke-width="0.1" opacity="0.9"/>`;
                clockHtml += `<text x="${x}" y="${y}" font-family="Arial" font-size="1.8" fill="black" text-anchor="middle" dominant-baseline="central">${i}</text>`;
            }

            return `
                <g transform="translate(40, 40)">
                    <rect x="-4" y="-38" width="8" height="76" fill="#ccff00" fill-opacity="0.3" />
                    <circle cx="0" cy="0" r="36" fill="url(#${gradientId})" />
                    <rect x="-35" y="-35" width="70" height="70" class="hairline" fill="none" stroke="#000" stroke-width="0.3"/>
                    <g transform="translate(0, -35)" font-family="Arial" font-size="2" text-anchor="middle">
                        <line x1="-20" y1="0" x2="-20" y2="3" class="hairline" fill="none" stroke="#000" stroke-width="0.3"/> <text x="-20" y="6">20</text>
                        <line x1="-10" y1="0" x2="-10" y2="3" class="hairline" fill="none" stroke="#000" stroke-width="0.3"/> <text x="-10" y="6">10</text>
                        <line x1="0" y1="0" x2="0" y2="3" class="hairline" fill="none" stroke="#000" stroke-width="0.3"/> <text x="0" y="6">0</text>
                        <line x1="10" y1="0" x2="10" y2="3" class="hairline" fill="none" stroke="#000" stroke-width="0.3"/> <text x="10" y="6">10</text>
                        <line x1="20" y1="0" x2="20" y2="3" class="hairline" fill="none" stroke="#000" stroke-width="0.3"/> <text x="20" y="6">20</text>
                    </g>
                    <g>${clockHtml}</g>
                    <text x="-22" y="32" font-family="Arial" font-size="2.2" fill="#94a3b8" font-weight="bold" text-anchor="middle">PLACE</text>
                    <text x="22" y="32" font-family="Arial" font-size="2.2" fill="#94a3b8" font-weight="bold" text-anchor="middle">POINT</text>
                    <circle cx="0" cy="0" r="${holeRadius}" fill="none" stroke="#444" stroke-width="0.2" stroke-dasharray="2 1"/>
                </g>
                <path d="M 0,80 L 0,5 Q 0,0 5,0 L 75,0 Q 80,0 80,5 L 80,80 L 60,80 L 60,95 L 20,95 L 20,80 Z" class="cut-line" fill="none" stroke="#ff0000" stroke-width="0.8" stroke-dasharray="4 2" />
                <text x="40" y="91" text-anchor="middle" font-size="2.5" fill="red" font-family="Arial" font-weight="900">CORTAR</text>
            `;
        }

        function getBaseSVG(label) {
            return `
                <text x="40" y="-8" text-anchor="middle" font-family="Arial" font-size="3" fill="#64748b" font-weight="bold">BASE SOPORTE (${label})</text>
                <rect x="0" y="0" width="80" height="40" rx="3" class="cut-line" fill="none" stroke="#ff0000" stroke-width="0.8" stroke-dasharray="4 2"/>
                <rect x="20" y="18.5" width="40" height="3" class="cut-line" fill="none" stroke="red" stroke-width="0.8" stroke-dasharray="4 2"/> 
                <text x="12" y="25" font-family="Arial" font-size="3" font-weight="bold" fill="#cbd5e1" text-anchor="middle">PLACE</text>
                <text x="68" y="25" font-family="Arial" font-size="3" font-weight="bold" fill="#cbd5e1" text-anchor="middle">POINT</text>
                <circle cx="40" cy="20" r="5" fill="#2563eb"/><text x="40" y="21.5" text-anchor="middle" font-family="Arial" font-size="4" font-weight="bold" fill="white">${label}</text>
            `;
        }

        function updatePack() {
            const themeSelect = document.getElementById('packThemeSelect').value;
            const customHex = document.getElementById('packCustomColor').value;
            const mode = document.getElementById('packMode').value;
            const hole = parseFloat(document.getElementById('holeSize').value);
            
            let themeColors = (themeSelect !== 'custom' && themesPack[themeSelect]) 
                              ? themesPack[themeSelect] 
                              : getShadesFromHex(customHex);

            document.getElementById('stop1').style.stopColor = themeColors.s1;
            document.getElementById('stop2').style.stopColor = themeColors.s2;
            document.getElementById('stop3').style.stopColor = themeColors.s3;

            const content = getSightSVG('gradPack', hole); 
            document.getElementById('packSightS').innerHTML = content;
            document.getElementById('packSightM').innerHTML = content;
            document.getElementById('packSightL').innerHTML = content;
            document.getElementById('packBaseS').innerHTML = getBaseSVG('S');
            document.getElementById('packBaseM').innerHTML = getBaseSVG('M');
            document.getElementById('packBaseL').innerHTML = getBaseSVG('L');
            
            const yOffset = mode === 'carom' ? 37.8 : 40;
            ['packSightS', 'packSightM', 'packSightL'].forEach(id => {
                const wrapper = document.getElementById(id);
                const graphic = wrapper.querySelector('g'); 
                if(graphic) graphic.setAttribute('transform', `translate(40, ${yOffset})`);
            });
        }

        function updateMat() {
            const name = document.getElementById('customName').value;
            const themeSelect = document.getElementById('matThemeSelect').value;
            let matColor = document.getElementById('matCustomColor').value;
            
            if (themeSelect === 'blue') matColor = '#2563eb';
            else if (themeSelect === 'green') matColor = '#065f46';
            else if (themeSelect === 'dark') matColor = '#1e293b';

            document.getElementById('matLogoText').textContent = name.trim() === '' ? 'STROKEMASTER PRO' : name.toUpperCase();
            document.getElementById('matBg').setAttribute('fill', matColor);
            
            const gTicks = document.getElementById('matRulerTicks');
            let tHtml = '';
            for(let mm = 0; mm <= 400; mm+=10) {
                const y = 450 - mm; if(y < 50) break; 
                const len = (mm % 50 === 0) ? 6 : 3;
                tHtml += `<line x1="25" y1="${y}" x2="${25+len}" y2="${y}" stroke="white" stroke-width="0.5"/>`;
                tHtml += `<line x1="225" y1="${y}" x2="${225-len}" y2="${y}" stroke="white" stroke-width="0.5"/>`;
                if(mm % 50 === 0) {
                    tHtml += `<text x="22" y="${y+1.5}" font-family="Arial" font-size="4" fill="white" text-anchor="end" opacity="0.8">${mm}mm</text>`;
                    tHtml += `<text x="228" y="${y+1.5}" font-family="Arial" font-size="4" fill="white" text-anchor="start" opacity="0.8">${mm/10}cm</text>`;
                }
            }
            gTicks.innerHTML = tHtml;

            const gMarkers = document.getElementById('matMarkers');
            let mHtml = '';
            [['S', 450], ['M', 300], ['L', 150]].forEach(([label, y]) => {
                mHtml += `<g transform="translate(125, ${y})">
                    <rect x="-40" y="-20" width="80" height="40" fill="none" stroke="white" stroke-width="0.5" stroke-dasharray="2 2" rx="2" opacity="0.6"/>
                    <circle cx="0" cy="0" r="8" fill="white" stroke="#2563eb" stroke-width="2"/>
                    <text x="0" y="2.8" text-anchor="middle" font-family="Arial" font-weight="900" font-size="9" fill="#2563eb">${label}</text>
                </g>`;
            });
            gMarkers.innerHTML = mHtml;
        }

        // --- MANEJO DEL MODAL Y EXPORTACI√ìN SEGURA ---
        function openTutorialModal() {
            document.getElementById('tutorial-modal').classList.add('active');
        }

        function closeTutorialModal() {
            document.getElementById('tutorial-modal').classList.remove('active');
        }

        async function downloadTutorialPDF() {
            // TECNOLOGIA DE VECTORES NATIVOS PARA PDF (Misma configuraci√≥n que el Slicers)
            const { jsPDF } = window.jspdf;
            
            // A4 en mil√≠metros
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            
            const m = 25.4; // Margen estricto Norma APA (1 pulgada)
            const pageWidth = doc.internal.pageSize.getWidth();
            const w = pageWidth - (m * 2); // Ancho de √°rea segura para el texto
            let y = m + 5;

            // --- CABECERA ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(22); 
            doc.setTextColor(30, 58, 138); // Color: #1e3a8a
            doc.text("ESPECIFICACIONES T√âCNICAS Y MONTAJE", pageWidth/2, y, {align: 'center'}); 
            y += 6;
            
            doc.setFontSize(10);
            doc.setTextColor(100, 116, 139); // Color: #64748b
            doc.text("DOCUMENTO OFICIAL DE PRODUCCI√ìN - FORMATO DIN A4 (210 x 297 mm)", pageWidth/2, y, {align: 'center'}); 
            y += 6;

            doc.setLineWidth(0.8); 
            doc.setDrawColor(37, 99, 235); // Color de la l√≠nea: #2563eb
            doc.line(m, y, pageWidth - m, y); 
            y += 12;

            // --- FUNCIONES DE CREACI√ìN DE TEXTO CON AUTO-AJUSTE ---
            const addH3 = (text) => {
                doc.setFont("helvetica", "bold"); 
                doc.setFontSize(14); 
                doc.setTextColor(37, 99, 235);
                doc.text(text, m, y); 
                y += 6;
            };
            const addP = (text) => {
                doc.setFont("helvetica", "normal"); 
                doc.setFontSize(11); 
                doc.setTextColor(51, 65, 85);
                const lines = doc.splitTextToSize(text, w); // Divide el texto para que no se salga de los m√°rgenes!
                doc.text(lines, m, y); 
                y += (lines.length * 5) + 2;
            };
            const addLi = (text) => {
                doc.setFont("helvetica", "normal"); 
                doc.setFontSize(11); 
                doc.setTextColor(51, 65, 85);
                const lines = doc.splitTextToSize("‚Ä¢ " + text, w - 5);
                doc.text(lines, m + 5, y); 
                y += (lines.length * 5) + 2;
            };

            // --- SECCI√ìN 1 ---
            addH3("1. Requisitos de Impresi√≥n y Hardware");
            addLi("Regla de Oro: La impresi√≥n debe realizarse estrictamente al 100% de escala (Tama√±o Real). Desactive ajustes como \"Ajustar a p√°gina\" o \"Fit to printable area\".");
            addLi("Modo de Color: Se recomienda utilizar perfil CMYK (FOGRA39) para garantizar la exactitud de los colores en medios f√≠sicos.");
            addLi("Maquinaria de Corte: El archivo vectorial A4 est√° optimizado para corte por l√°ser o plotter, usando las l√≠neas rojas discontinuas como vectores gu√≠a de corte.");
            y += 4;

            // --- SECCI√ìN 2 ---
            addH3("2. Materiales: Plantillas (Fichas)");
            addP("Las fichas verticales requieren un material que no se combe. Recomendamos:");
            addLi("Acetato R√≠gido (Grosor 250 - 300 micras).");
            addLi("PETG Transparente (1mm) impreso en cama plana UV.");
            addP("Importante: El c√≠rculo central del objetivo debe quedar 100% transparente.");
            y += 4;

            // --- SECCI√ìN 3 ---
            addH3("3. Materiales: Tapete y Bases");
            addP("Tapete (60x25cm):");
            addLi("Ideal: Neopreno 3mm (tipo mousepad). Absorbe impactos.");
            addLi("Alternativa: Lona Vin√≠lica 13oz mate.");
            addP("Bases (8x4cm): Cortar en Acr√≠lico Negro o Blanco de 3mm para estabilizar la ficha.");
            y += 4;

            // --- SECCI√ìN 4 ---
            addH3("4. Ensamblaje y Tolerancias de Fabricaci√≥n");
            addLi("Corte Central: Utilice un comp√°s de corte o un bistur√≠ de precisi√≥n tipo X-Acto. Un agujero irregular generar√° fricci√≥n no deseada en el taco de billar.");
            addLi("Ranura de la Base (Slot): El rect√°ngulo interno de la base est√° marcado como gu√≠a. El operador debe ajustar el ancho del corte al grosor exacto del acetato o PETG utilizado (ej. 0.5mm, 1mm).");
            addLi("Limpieza: Lije suavemente los bordes del agujero central con lija de agua de grano fino para un deslizamiento fluido del taco.");
            y += 10;

            // --- CAJA DE CONTROL DE CALIDAD ---
            doc.setLineWidth(0.5);
            doc.setDrawColor(148, 163, 184); // Borde punteado gris
            doc.setLineDashPattern([2, 2], 0);
            doc.setFillColor(248, 250, 252);
            doc.roundedRect(m, y, w, 38, 3, 3, 'FD'); // Dibuja la caja perfectamente alineada
            doc.setLineDashPattern([], 0); // Regresa a l√≠nea normal
            
            y += 10;
            doc.setFont("helvetica", "bold"); 
            doc.setFontSize(12); 
            doc.setTextColor(30, 41, 59);
            doc.text("CONTROL DE CALIDAD - VERIFICACI√ìN DE ESCALA REAL", pageWidth/2, y, {align: 'center'}); 
            y += 8;
            
            doc.setFontSize(10); 
            doc.setTextColor(51, 65, 85);
            doc.text("DISTANCIA EXACTA: 50.0 mm / 5.0 cm", pageWidth/2, y, {align: 'center'}); 
            y += 8;

            // --- REGLA DE MEDICI√ìN MATEM√ÅTICA ---
            // Usar mil√≠metros exactos previene que las impresoras se equivoquen con la escala
            const centerX = pageWidth/2;
            doc.setLineWidth(1);
            doc.setDrawColor(0, 0, 0);
            doc.line(centerX - 25, y, centerX + 25, y); // L√≠nea central de exactamente 50mm
            doc.line(centerX - 25, y - 3, centerX - 25, y + 3); // L√≠mite izquierdo
            doc.line(centerX + 25, y - 3, centerX + 25, y + 3); // L√≠mite derecho

            // --- FOOTER ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(8); 
            doc.setTextColor(148, 163, 184);
            const pageHeight = doc.internal.pageSize.getHeight();
            doc.text("DISE√ëADO POR JUAN MIGUEL RIOS REDONDO ¬© 2026 - STROKEMASTER PRO", pageWidth/2, pageHeight - 15, {align:'center'});

            doc.save("StrokeMaster_Pro_Guia_Tecnica.pdf");
        }

        function downloadPDF(elementId, filename) {
            const element = document.getElementById(elementId);
            const isMat = elementId === 'mat-sheet';
            const opt = {
                margin: 0, filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 3, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: isMat ? [250, 600] : 'a4', orientation: 'portrait', compress: true },
                pagebreak: { mode: 'avoid-all' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function switchAppTab(e, tab) {
            document.querySelectorAll('#app2-wrapper .workspace').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('#app2-wrapper .tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('ws-'+tab).classList.add('active');
            e.currentTarget.classList.add('active');
            if(tab === 'pack') updatePack();
            if(tab === 'mat') updateMat();
        }

        syncPackColor();
        syncMatColor();
    </script>
</body>
</html>
