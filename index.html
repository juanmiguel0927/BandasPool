<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Profesional ABPC - Juan Miguel Rios Redondo</title>
    <!-- Librería PDF (Estándar Industrial) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e67e22; /* Naranja Energético */
            --bg: #ecf0f1;
            --glass: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--primary);
            background-image: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
        }

        .main-panel {
            background-color: var(--glass);
            padding: 30px;
            border-radius: 16px;
            width: 95%;
            max-width: 900px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border-top: 6px solid var(--accent);
            backdrop-filter: blur(10px);
        }

        /* --- CABECERA --- */
        .header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        h1 { margin: 0; font-size: 24px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        
        /* --- GRID DE CONTROLES --- */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .control-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            transition: transform 0.2s;
        }
        .control-group:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        label { display: block; font-weight: 700; font-size: 12px; margin-bottom: 8px; color: #555; text-transform: uppercase; }
        
        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 6px;
            font-size: 14px;
            background: #f9f9f9;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        select:focus, input:focus { border-color: var(--accent); outline: none; background: white; }

        /* Botones Rápidos */
        .quick-qty { display: flex; gap: 8px; margin-top: 10px; }
        .q-btn {
            flex: 1;
            background: #dfe6e9;
            border: none;
            padding: 8px;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            color: #2d3436;
            font-weight: bold;
            transition: background 0.2s;
        }
        .q-btn:hover { background: #b2bec3; }
        .q-btn.active { background: var(--primary); color: white; }

        /* Toggle Modo */
        .toggle-container {
            display: flex;
            background: #eee;
            border-radius: 6px;
            padding: 4px;
            margin-bottom: 15px;
        }
        .toggle-btn {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            color: #777;
        }
        .toggle-btn.active { background: white; color: var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Botón Acción */
        .btn-action {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            border: none;
            padding: 20px;
            width: 100%;
            font-size: 18px;
            font-weight: 800;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 10px 20px rgba(230, 126, 34, 0.3);
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .btn-action:hover { transform: translateY(-3px); box-shadow: 0 15px 25px rgba(230, 126, 34, 0.4); }

        /* Info Box */
        .info-box {
            background: #dff9fb;
            color: #130f40;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            border-left: 4px solid #22a6b3;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Vista Previa Visual */
        .visual-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 4px;
            background: #95a5a6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #7f8c8d;
        }
        .mini-strip {
            height: 10px;
            background: #2c3e50;
            border-radius: 2px;
        }

        /* --- CRÉDITOS --- */
        .footer-cr {
            text-align: center;
            margin-top: 30px;
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            line-height: 1.5;
        }
        .footer-cr strong {
            color: #fff;
            font-size: 13px;
        }
    </style>
</head>
<body>

<div class="main-panel">
    <div class="header">
        <h1>Generador Maestro de Slicers</h1>
    </div>

    <div class="controls-grid">
        <!-- GRUPO 1: PRODUCCIÓN -->
        <div class="control-group">
            <label>1. Objetivo de Producción</label>
            <input type="number" id="totalStrips" value="72" min="1" onchange="updateCalc()">
            <div class="quick-qty">
                <button class="q-btn" onclick="setQty(24)">1 Mesa (24)</button>
                <button class="q-btn" onclick="setQty(48)">2 Mesas (48)</button>
                <button class="q-btn active" onclick="setQty(72)">3 Mesas (72)</button>
            </div>
            <div style="margin-top:15px;">
                <label>Medida de Mesa</label>
                <select id="sizeType" onchange="updateCalc()">
                    <option value="mix">MIXTO (Equilibrado)</option>
                    <option value="10">Solo 10 Pies (14")</option>
                    <option value="9">Solo 9 Pies (12.5")</option>
                    <option value="8">Solo 8 Pies (11")</option>
                </select>
            </div>
        </div>

        <!-- GRUPO 2: FORMATO -->
        <div class="control-group">
            <label>2. Formato de Salida</label>
            <div class="toggle-container">
                <div class="toggle-btn active" id="btnSheet" onclick="setMode('sheet')">HOJAS (PAGINADO)</div>
                <div class="toggle-btn" id="btnRoll" onclick="setMode('roll')">ROLLO (PLOTTER)</div>
            </div>
            
            <div id="panelSheet">
                <label>Tamaño de Hoja</label>
                <select id="paperStandard" onchange="updateCalc()">
                    <option value="tabloid">Tabloide (11" x 17")</option>
                    <option value="superTabloid">Super Tabloide (12" x 18")</option>
                    <option value="a3">A3 (29.7cm x 42cm)</option>
                    <option value="a3plus">A3+ / Super B (33cm x 48cm)</option>
                </select>
            </div>

            <div id="panelRoll" style="display:none;">
                <label>Ancho del Rollo (cm)</label>
                <input type="number" id="rollWidth" value="60" onchange="updateCalc()">
                <small style="color:#888;">El largo se calculará automáticamente.</small>
            </div>
        </div>

        <!-- GRUPO 3: DISEÑO -->
        <div class="control-group">
            <label>3. Personalización</label>
            <div style="margin-bottom:15px;">
                <label>Etiqueta Central</label>
                <input type="text" id="labelText" value="ABPC" placeholder="Nombre del Club" onkeyup="updateCalc()">
            </div>
            <div>
                <label>Color de Fondo</label>
                <select id="bgMode" onchange="updateCalc()">
                    <option value="black">Negro (Clásico)</option>
                    <option value="transparent">Transparente (Solo Corte)</option>
                    <option value="blue">Azul Torneo</option>
                    <option value="green">Verde Paño</option>
                </select>
            </div>
        </div>
    </div>

    <div class="info-box" id="statusMsg">
        <!-- JS inyectará info aquí -->
    </div>

    <button class="btn-action" onclick="generatePDF()">
        <span>⬇</span> Generar PDF Maestro
    </button>
    
    <label style="margin-top:20px;">Previsualización de Lote:</label>
    <div class="visual-preview" id="previewGrid"></div>
</div>

<div class="footer-cr">
    Herramienta desarrollada por <strong>Juan Miguel Rios Redondo</strong><br>
    <span id="copyright-text"></span>
</div>

<script>
    // --- AUTOGENERAR AÑO COPYRIGHT ---
    document.getElementById('copyright-text').innerText = "© " + new Date().getFullYear();

    // --- VARIABLES DE ESTADO ---
    let mode = 'sheet'; // 'sheet' o 'roll'
    
    // Dimensiones Físicas (Pulgadas)
    const STRIP_H = 1.35; 
    const GAP_X = 0.1;    // Espacio horizontal entre tiras
    const GAP_Y = 0.2;    // Espacio vertical
    const MARGIN = 0.3;   // Margen seguro
    
    let calc = {
        paperW: 0,
        paperH: 0,
        cols: 0,
        rowsPerPage: 0,
        totalPages: 0,
        stripsPerPage: 0,
        stripsToPrint: [] // Array de objetos {w, label}
    };

    // --- UI LOGIC ---
    function setQty(n) {
        document.getElementById('totalStrips').value = n;
        // Update active class
        document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        updateCalc();
    }

    function setMode(m) {
        mode = m;
        document.getElementById('btnSheet').className = m === 'sheet' ? 'toggle-btn active' : 'toggle-btn';
        document.getElementById('btnRoll').className = m === 'roll' ? 'toggle-btn active' : 'toggle-btn';
        
        document.getElementById('panelSheet').style.display = m === 'sheet' ? 'block' : 'none';
        document.getElementById('panelRoll').style.display = m === 'roll' ? 'block' : 'none';
        updateCalc();
    }

    // --- CORE CALCULATION ---
    function updateCalc() {
        const qty = parseInt(document.getElementById('totalStrips').value) || 24;
        const type = document.getElementById('sizeType').value;
        const bgMode = document.getElementById('bgMode').value;
        
        // 1. Generar Lista de Tiras
        calc.stripsToPrint = [];
        if (type === 'mix') {
            const base = Math.floor(qty / 3);
            let rem = qty % 3;
            // Ordenar: Grandes primero para optimizar ancho columna
            for(let i=0; i < base + (rem>0?1:0); i++) calc.stripsToPrint.push({w:14.0, l:"10 Pies"});
            for(let i=0; i < base + (rem>1?1:0); i++) calc.stripsToPrint.push({w:12.5, l:"9 Pies"});
            for(let i=0; i < base; i++) calc.stripsToPrint.push({w:11.0, l:"8 Pies"});
        } else {
            let s = 14.0, l = "10 Pies";
            if(type==='9'){s=12.5; l="9 Pies";}
            if(type==='8'){s=11.0; l="8 Pies";}
            for(let i=0; i<qty; i++) calc.stripsToPrint.push({w:s, l:l});
        }

        // 2. Determinar Papel
        if (mode === 'sheet') {
            const pt = document.getElementById('paperStandard').value;
            if(pt==='tabloid') { calc.paperW=17; calc.paperH=11; }
            if(pt==='superTabloid') { calc.paperW=18; calc.paperH=12; }
            if(pt==='a3') { calc.paperW=16.54; calc.paperH=11.69; }
            if(pt==='a3plus') { calc.paperW=19; calc.paperH=13; }
        } else {
            const wCm = parseFloat(document.getElementById('rollWidth').value) || 60;
            calc.paperW = wCm / 2.54;
            // Altura infinita por ahora
        }

        // 3. Calcular Grid
        // Usamos el ancho de la tira más grande (14.0) + marcas de corte (0.2 approx)
        const colWidth = 14.2; 
        const rowHeight = STRIP_H + GAP_Y;

        const usableW = calc.paperW - (MARGIN*2);
        calc.cols = Math.floor(usableW / colWidth);
        if(calc.cols < 1) calc.cols = 1;

        if (mode === 'sheet') {
            const usableH = calc.paperH - (MARGIN*2) - 0.5; // 0.5 header
            calc.rowsPerPage = Math.floor(usableH / rowHeight);
            calc.stripsPerPage = calc.cols * calc.rowsPerPage;
            calc.totalPages = Math.ceil(qty / calc.stripsPerPage);
        } else {
            const totalRows = Math.ceil(qty / calc.cols);
            calc.paperH = (totalRows * rowHeight) + (MARGIN*2) + 1.0; // +1.0 header
            calc.rowsPerPage = totalRows;
            calc.totalPages = 1;
        }

        // 4. Actualizar UI
        const status = document.getElementById('statusMsg');
        const wCm = (calc.paperW * 2.54).toFixed(1);
        const hCm = (calc.paperH * 2.54).toFixed(1);
        
        if(mode === 'sheet') {
            status.innerHTML = `<strong>Producción Paginada:</strong> Se generarán <strong>${calc.totalPages} páginas</strong> tamaño ${wCm}x${hCm}cm.<br>Cada página contiene hasta ${calc.stripsPerPage} tiras.`;
        } else {
            status.innerHTML = `<strong>Producción en Rollo:</strong> Se generará un archivo único de <strong>${wCm}cm x ${hCm}cm</strong>.<br>Optimizado para corte en plotter.`;
        }

        // Preview Visual
        const preview = document.getElementById('previewGrid');
        preview.innerHTML = '';
        let color = '#2c3e50';
        if(bgMode==='transparent') color = '#ecf0f1'; // Gris claro
        if(bgMode==='blue') color = '#0984e3';
        if(bgMode==='green') color = '#00b894';

        calc.stripsToPrint.forEach(s => {
            const d = document.createElement('div');
            d.className = 'mini-strip';
            d.style.backgroundColor = color;
            if(bgMode==='transparent') d.style.border = "1px solid #333";
            d.title = s.l;
            preview.appendChild(d);
        });
    }

    // --- PDF GENERATOR ---
    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const orientation = calc.paperW > calc.paperH ? 'l' : 'p';
        
        const doc = new jsPDF({
            orientation: orientation,
            unit: 'in',
            format: [calc.paperW, calc.paperH]
        });

        const labelTxt = document.getElementById('labelText').value;
        const bgMode = document.getElementById('bgMode').value;
        
        // Colores
        let fillCol = null, txtCol = [0,0,0], lineCol = [0,255,255]; // Default
        const cBlack = [15,15,15];
        const cWhite = [255,255,255];
        const cGold = [255, 215, 0];
        
        if(bgMode==='black') { fillCol=cBlack; txtCol=cWhite; lineCol=[0,255,255]; }
        if(bgMode==='transparent') { fillCol=null; txtCol=[0,0,0]; lineCol=[0,150,150]; }
        if(bgMode==='blue') { fillCol=[10,60,120]; txtCol=cWhite; lineCol=[255,255,255]; }
        if(bgMode==='green') { fillCol=[20,90,50]; txtCol=cWhite; lineCol=[255,255,255]; }

        // Layout Vars
        let cursorX = MARGIN;
        let cursorY = 1.0; 
        let itemsOnPage = 0;
        let colIdx = 0;
        const colW = 14.2; // Slot fijo para alinear columnas

        // Footer Author Function
        const addFooter = (pNum) => {
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(`Desarrollado por Juan Miguel Rios Redondo - Pág ${pNum}`, MARGIN, calc.paperH - 0.2);
        };

        // Header Function
        const addHeader = () => {
             doc.setFontSize(14);
             doc.setTextColor(0);
             doc.text(`ORDEN DE PRODUCCIÓN ABPC - ${calc.stripsToPrint.length} UNIDADES`, calc.paperW/2, 0.5, {align:'center'});
        };

        addHeader();
        addFooter(1);

        calc.stripsToPrint.forEach((strip, i) => {
            // Check Page Break (Sheet Mode)
            if (mode === 'sheet' && itemsOnPage >= calc.stripsPerPage) {
                doc.addPage();
                cursorX = MARGIN;
                cursorY = 1.0;
                itemsOnPage = 0;
                colIdx = 0;
                addHeader();
                addFooter(doc.internal.getNumberOfPages());
            }

            // Draw Strip
            drawStripVector(doc, cursorX, cursorY, strip.w, STRIP_H, strip.l, labelTxt, fillCol, txtCol, lineCol, cGold);

            // Move Cursor
            colIdx++;
            itemsOnPage++;
            
            if (colIdx >= calc.cols) {
                colIdx = 0;
                cursorX = MARGIN;
                cursorY += (STRIP_H + GAP_Y);
            } else {
                cursorX += colW;
            }
        });

        doc.save(`Slicers_JMRR_${calc.stripsToPrint.length}_Unidades.pdf`);
    }

    function drawStripVector(doc, x, y, w, h, subLabel, mainLabel, fill, txt, line, gold) {
        // 1. Fondo
        if(fill) {
            doc.setFillColor(fill[0], fill[1], fill[2]);
            doc.rect(x, y, w, h, 'F');
        } else {
            // Outline para transparente
            doc.setDrawColor(0);
            doc.setLineWidth(0.01);
            doc.rect(x, y, w, h, 'S');
        }

        // 2. Crop Marks (Marcas de Corte) - PRO FEATURE
        doc.setDrawColor(0);
        doc.setLineWidth(0.01);
        const cmLen = 0.15; // Longitud marca
        // Top Left
        doc.line(x, y, x - cmLen, y); // Horiz
        doc.line(x, y, x, y - cmLen); // Vert
        // Top Right
        doc.line(x+w, y, x+w+cmLen, y);
        doc.line(x+w, y, x+w, y-cmLen);
        // Bottom Left
        doc.line(x, y+h, x-cmLen, y+h);
        doc.line(x, y+h, x, y+h+cmLen);
        // Bottom Right
        doc.line(x+w, y+h, x+w+cmLen, y+h);
        doc.line(x+w, y+h, x+w, y+h+cmLen);

        // 3. Línea Central
        doc.setDrawColor(line[0], line[1], line[2]);
        doc.setLineWidth(0.02);
        doc.line(x, y+h/2, x+w, y+h/2);

        // 4. Ticks
        const step = w/10;
        doc.setLineWidth(0.03);
        for(let t=1; t<10; t++) {
            if(t===5) continue;
            let tx = x + (step*t);
            doc.line(tx, y + h/2 - 0.2, tx, y + h/2 + 0.2);
        }

        // 5. Diamante
        doc.setFillColor(gold[0], gold[1], gold[2]);
        const cx = x + w/2;
        const cy = y + h/2;
        doc.triangle(cx, cy-0.25, cx+0.25, cy, cx-0.25, cy, 'F');
        doc.triangle(cx, cy+0.25, cx+0.25, cy, cx-0.25, cy, 'F');

        // 6. Textos
        doc.setTextColor(txt[0], txt[1], txt[2]);
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text(mainLabel, cx, y + h - 0.2, {align:'center'});

        doc.setFontSize(8);
        doc.setTextColor(100);
        doc.text(subLabel, x + 0.1, y + 0.15); // Label interno superior
    }

    // Init
    updateCalc();
</script>

</body>
</html>

